<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro</title>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary-color: #06d6a0;
            --secondary-dark: #05c296;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            
            /* Dark theme colors */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3a;
            --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f;
            --bg-hover: #252647;
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-accent: #f1f5f9;
            
            --border-color: #374151;
            --border-light: #4b5563;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            --glow-secondary: 0 0 20px rgba(6, 214, 160, 0.3);
            --glow-accent: 0 0 20px rgba(245, 158, 11, 0.3);

            /* Colori per heatmap */
            --heatmap-empty: #374151;
            --heatmap-low: #ef4444;
            --heatmap-medium: #f59e0b;
            --heatmap-high: #10b981;
            --heatmap-very-high: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animazioni */
        .section {
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: sectionSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes sectionSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Container Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            background-size: 200% 200%;
            animation: gradientShift 6s ease infinite;
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 8s infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary), var(--shadow);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .card h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s;
            transform: translate(-50%, -50%);
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-primary), var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-secondary), var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* TODAY SECTION STYLES */
        .oggi-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--primary-color);
        }

        .oggi-card::before {
            background: var(--primary-color);
        }

        .oggi-card h3 {
            color: var(--primary-light) !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .prossimo-task {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .task-corrente {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .materia-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tempo-stimato {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .task-descrizione {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .task-motivazione {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .task-options {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-options h5 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .task-option-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .task-option-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateX(8px);
        }

        .task-option-btn.selected {
            border-color: var(--primary-color);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: var(--glow-primary);
        }

        .timeline-oggi {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .timeline-time {
            font-weight: 700;
            min-width: 80px;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .timeline-content {
            flex: 1;
            margin-left: 1rem;
            color: var(--text-primary);
        }

        /* RECOVERY DASHBOARD */
        .recovery-dashboard {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .missed-time {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .highlight {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .recovery-plan {
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        /* MICRO TASKS */
        .micro-tasks {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .micro-task-item {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .micro-task-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(8px);
        }

        .micro-task-duration {
            font-size: 0.8rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* SLOT TEMPORALI STYLES */
        .weekly-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .day-slots {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .day-slots h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            text-align: center;
        }

        .time-slots {
            space-y: 1rem;
        }

        .slot-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .slot-item input[type="time"] {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            width: auto;
            min-width: 100px;
        }

        .add-slot {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .add-slot:hover {
            border-color: var(--primary-color);
            color: var(--primary-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .remove-slot {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .remove-slot:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 6px;
            margin-top: 0.5rem;
        }

        .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.active {
            color: #fbbf24;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }

        /* Subject Items */
        .subject-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .subject-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        }

        .subject-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .subject-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .subject-actions {
            display: flex;
            gap: 0.75rem;
        }

        .subject-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-alta { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .priority-media { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .priority-bassa { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Timer */
        .timer-container {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: var(--primary-light);
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
        }

        .timer-display.break-mode {
            color: var(--secondary-color);
            text-shadow: 0 0 30px rgba(6, 214, 160, 0.5);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .preset-btn {
            padding: 1rem;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }

        .preset-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary);
        }

        /* Daily Goal Settings */
        .daily-goal-settings {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .daily-goal-settings h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
        }

        .goal-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-input {
            width: 100px;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }

        .goal-input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Streak */
        .streak-card {
            background: linear-gradient(135deg, var(--accent-color), #d97706);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from { box-shadow: var(--shadow-lg); }
            to { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4), var(--shadow-lg); }
        }

        .streak-number {
            font-size: 4rem;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: modalEnter 0.3s ease;
        }

        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Rating Modal Post-Sessione */
        .rating-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 3rem 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: ratingModalEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ratingModalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.5) translateY(100px) rotate(-10deg);
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        .rating-modal h3 {
            color: var(--primary-light);
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .rating-modal p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 2rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .rating-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .rating-btn.sleepy:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
            box-shadow: 0 0 20px rgba(107, 114, 128, 0.3);
        }

        .rating-btn.neutral:hover {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .rating-btn.good:hover {
            border-color: var(--secondary-color);
            background: rgba(6, 214, 160, 0.1);
            box-shadow: 0 0 20px rgba(6, 214, 160, 0.3);
        }

        .rating-btn.excellent:hover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .rating-emoji {
            font-size: 3.5rem;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .rating-btn:hover .rating-emoji {
            transform: scale(1.2) rotate(5deg);
        }

        .rating-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .rating-btn.sleepy .rating-label { color: #9ca3af; }
        .rating-btn.neutral .rating-label { color: var(--warning-color); }
        .rating-btn.good .rating-label { color: var(--secondary-color); }
        .rating-btn.excellent .rating-label { color: var(--success-color); }

        /* Session List Styles */
        .session-list {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .session-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .session-time {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.1rem;
        }

        .session-materia {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .session-note {
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 0.5rem;
        }

        .session-rating {
            display: flex;
            gap: 2px;
        }

        .session-rating .star {
            font-size: 1rem;
            color: #fbbf24;
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        /* Heatmap 24 ore */
        .hourly-heatmap {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 50px;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .heatmap-cell.empty {
            background: var(--heatmap-empty);
            color: var(--text-muted);
        }

        .heatmap-cell.low {
            background: var(--heatmap-low);
            color: white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .heatmap-cell.medium {
            background: var(--heatmap-medium);
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .heatmap-cell.high {
            background: var(--heatmap-high);
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .heatmap-cell.very-high {
            background: var(--heatmap-very-high);
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            animation: pulseHeat 2s ease-in-out infinite alternate;
        }

        @keyframes pulseHeat {
            from { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
            to { box-shadow: 0 0 25px rgba(34, 197, 94, 0.6); }
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Top Hours Section */
        .top-hours-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .top-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .top-hour-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .top-hour-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
        }

        .top-hour-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--success-color);
        }

        .top-hour-rank {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success-color);
            margin-bottom: 0.5rem;
        }

        .top-hour-time {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }

        .top-hour-rating {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .productivity-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 4px solid var(--primary-color);
        }

        .productivity-suggestion h4 {
            color: var(--primary-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .productivity-suggestion p {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Tooltip per heatmap */
        .tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-content {
            text-align: center;
            animation: focusEnter 0.5s ease;
        }

        .focus-timer {
            font-size: 8rem;
            font-weight: 800;
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 50px rgba(139, 92, 246, 0.8);
        }

        .close-focus {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .close-focus:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        @keyframes focusEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Calendario Styles - FIXED */
        .calendar-container {
            width: 100%;
            max-width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day-header {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-light);
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card);
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--bg-hover);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .calendar-day.other-month {
            background: var(--bg-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--bg-card);
            border: 2px solid var(--accent-color);
            font-weight: 700;
        }

        .calendar-day.has-sessions {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .calendar-day.has-scheduled {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .calendar-sessions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-session-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }

        .session-completed {
            background: var(--primary-color);
        }

        .session-scheduled {
            background: var(--secondary-color);
        }

        .session-manual {
            background: var(--warning-color);
        }

        .calendar-session-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
        }

        /* Modal Aggiungi Sessione */
        .add-session-modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .add-session-modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Day Detail Modal */
        .day-detail-modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .day-sessions-grid {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .day-session-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .day-session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-details {
            flex: 1;
        }

        .session-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 0.25rem;
        }

        .session-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Add Note Modal */
        .note-modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .timer-display {
                font-size: 4rem;
            }

            .focus-timer {
                font-size: 6rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .subject-info {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                padding: 6px;
            }

            .nav-tab {
                padding: 12px 16px;
                min-width: 100px;
                font-size: 0.9rem;
            }

            .card {
                padding: 1.5rem;
            }

            .timer-controls {
                flex-direction: column;
                align-items: center;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .streak-number {
                font-size: 3rem;
            }

            .weekly-slots {
                grid-template-columns: 1fr;
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .heatmap-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .rating-buttons {
                grid-template-columns: 1fr;
            }

            .rating-btn {
                padding: 1.5rem 1rem;
            }

            .rating-emoji {
                font-size: 2.5rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .calendar-day-number {
                font-size: 0.9rem;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .calendar-session-count {
                font-size: 0.6rem;
            }

            .session-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üöÄ Piano Studio Smart AI Pro</h1>
            <p>Il tuo assistente intelligente anti-procrastinazione personalizzato</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('oggi', this)">üåÖ Oggi</button>
            <button class="nav-tab" onclick="showSection('materie', this)">üìñ Materie</button>
            <button class="nav-tab" onclick="showSection('piano', this)">üìã Piano Studio</button>
            <button class="nav-tab" onclick="showSection('pomodoro', this)">üçÖ Pomodoro</button>
            <button class="nav-tab" onclick="showSection('calendario', this)">üìÖ Calendario</button>
            <button class="nav-tab" onclick="showSection('statistiche', this)">üìä Statistiche</button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sezione OGGI -->
            <section id="oggi" class="section active">
                <!-- Recovery Dashboard -->
                <div class="recovery-dashboard" id="recoveryDashboard" style="display: none;">
                    <h4>üìä Stato Recupero</h4>
                    <div class="missed-time">Tempo da recuperare: <span class="highlight" id="missedTime">0h 0min</span></div>
                    <div class="recovery-plan" id="recoveryPlan">Piano: Distribuzione automatica attiva</div>
                    <button class="btn btn-warning" onclick="showRecoveryOptions()">üîß Modifica Piano</button>
                </div>

                <div class="card oggi-card">
                    <h3>üåÖ Il Tuo Piano di Oggi</h3>
                    
                    <div class="prossimo-task">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">üî• PROSSIMO TASK:</h4>
                        <div class="task-corrente" id="taskCorrente">
                            <div class="task-header">
                                <span class="materia-nome" id="currentTaskMateria">Nessun task programmato</span>
                                <span class="tempo-stimato" id="currentTaskTime">‚è±Ô∏è -- min</span>
                            </div>
                            <div class="task-descrizione" id="currentTaskDesc">
                                Aggiungi delle materie per iniziare a studiare in modo intelligente!
                            </div>
                            <div class="task-motivazione" id="currentTaskMotivation">
                                üí° Il sistema pianificher√† automaticamente le tue sessioni di studio
                            </div>

                            <div class="task-options" id="taskOptions" style="display: none;">
                                <h5>üéØ Cosa vuoi fare specificamente?</h5>
                                <div id="taskOptionsList"></div>
                            </div>

                            <button class="btn btn-primary" onclick="iniziaTask()" id="startTaskBtn" disabled>üöÄ Inizia Subito</button>
                        </div>
                    </div>

                    <!-- Micro Tasks per Anti-Procrastinazione -->
                    <div class="micro-tasks" id="microTasks" style="display: none;">
                        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">‚ö° Task Micro (Anti-Procrastinazione)</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Inizia con qualcosa di facile per creare momentum:</p>
                        <div id="microTasksList"></div>
                    </div>

                    <div class="programma-giornata">
                        <h4 style="color: var(--primary-light);">üìã Programma Completo di Oggi:</h4>
                        <div class="timeline-oggi" id="timelineOggi">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÖ</div>
                                <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Materie -->
            <section id="materie" class="section">
                <!-- Study Streak Card -->
                <div class="streak-card">
                    <h3 style="margin-bottom: 1rem; color: white;">üî• Studio Streak</h3>
                    <div class="streak-number" id="streakNumber">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <div class="card">
                    <h3>‚ûï Aggiungi Nuova Materia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagine">Pagine Totali <span class="required">*</span></label>
                            <input type="number" id="pagine" min="1" required placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="pagineStudiate">Pagine gi√† Studiate</label>
                            <input type="number" id="pagineStudiate" min="0" value="0" placeholder="Es. 120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineOra">Pagine per Ora</label>
                            <input type="number" id="pagineOra" min="1" max="50" value="8" placeholder="Es. 8">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Quante pagine riesci a studiare in 1 ora per questa materia</small>
                        </div>
                        <div class="form-group">
                            <label for="eserciziTotali">Esercizi Totali</label>
                            <input type="number" id="eserciziTotali" min="0" value="0" placeholder="Es. 150">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Numero totale di esercizi da completare (opzionale)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eserciziCompletati">Esercizi Completati</label>
                            <input type="number" id="eserciziCompletati" min="0" value="0" placeholder="Es. 45">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Esercizi gi√† completati</small>
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorit√†</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficolt√† Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1">‚òÖ</span>
                                <span class="star" data-rating="2">‚òÖ</span>
                                <span class="star" data-rating="3">‚òÖ</span>
                                <span class="star" data-rating="4">‚òÖ</span>
                                <span class="star" data-rating="5">‚òÖ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Slot Temporali -->
                    <div class="form-group">
                        <label>‚è∞ Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Definisci gli slot orari specifici in cui puoi studiare questa materia durante la settimana
                        </p>
                        <div class="weekly-slots" id="weeklySlots">
                            <!-- Slot per ogni giorno generati dinamicamente -->
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addMateria()">‚úÖ Aggiungi Materia</button>
                </div>

                <div class="card">
                    <h3>üìö Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìö</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                            <p>Inizia aggiungendo la tua prima materia!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Piano Studio -->
            <section id="piano" class="section">
                <div class="card">
                    <h3>üìã Piano di Studio Intelligente</h3>
                    <div id="aiInsights" style="margin-bottom: 2rem;"></div>
                    <div id="pianoStudio">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Pomodoro -->
            <section id="pomodoro" class="section">
                <!-- Impostazioni Obiettivo Giornaliero -->
                <div class="daily-goal-settings">
                    <h4>üéØ Obiettivo Giornaliero Personalizzato</h4>
                    <div class="goal-input-group">
                        <label for="dailyGoal" style="margin: 0; color: var(--text-primary);">Pomodori da completare oggi:</label>
                        <input type="number" id="dailyGoal" class="goal-input" min="1" max="20" value="8" onchange="updateDailyGoal()">
                        <span style="color: var(--text-secondary);">sessioni</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Personalizza il tuo obiettivo giornaliero in base al tempo che hai disponibile
                    </p>
                </div>

                <div class="card">
                    <div class="timer-container">
                        <h3>üçÖ Timer Pomodoro</h3>
                        
                        <div class="timer-presets">
                            <button class="preset-btn active" onclick="setPreset(25, 5, this)">25/5 min</button>
                            <button class="preset-btn" onclick="setPreset(50, 10, this)">50/10 min</button>
                            <button class="preset-btn" onclick="setPreset(90, 20, this)">90/20 min</button>
                            <button class="preset-btn" onclick="showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startBtn" onclick="startTimer()">‚ñ∂Ô∏è Inizia</button>
                            <button class="btn btn-warning" id="pauseBtn" onclick="pauseTimer()" style="display: none;">‚è∏Ô∏è Pausa</button>
                            <button class="btn btn-danger" onclick="resetTimer()">üîÑ Reset</button>
                            <button class="btn btn-secondary" onclick="toggleFocusMode()">üéØ Focus</button>
                        </div>

                        <div class="form-group">
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="progressText">Inizia la tua prima sessione!</small>
                        </div>
                    </div>
                </div>

                <!-- Lista Sessioni di Oggi -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">üìä Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="showDeleteAllTodaySessionsModal()">üóëÔ∏è Elimina tutte</button>
                    </div>
                    
                    <div id="todaySessionsList" class="session-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üçÖ</div>
                            <p>Nessuna sessione completata oggi.</p>
                            <p>Avvia una sessione per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Calendario -->
            <section id="calendario" class="section">
                <!-- Controlli Calendario -->
                <div class="card">
                    <h3>üìÖ Navigazione Calendario</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="changeMonth(-1)" style="padding: 0.75rem 1rem;">‚óÄ Precedente</button>
                            <h4 id="currentMonthYear" style="margin: 0; color: var(--primary-light); min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary" onclick="changeMonth(1)" style="padding: 0.75rem 1rem;">Successivo ‚ñ∂</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="goToToday()" style="padding: 0.75rem 1rem;">üìç Oggi</button>
                            <button class="btn btn-warning" onclick="addManualSession()" style="padding: 0.75rem 1rem;">‚ûï Aggiungi Sessione</button>
                        </div>
                    </div>
                </div>

                <!-- Legenda -->
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 2rem; align-items: center; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--primary-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni completate</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--secondary-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Slot programmati</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--warning-color); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni manuali</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background: var(--accent-color); border: 2px solid var(--text-primary); border-radius: 4px;"></div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Oggi</span>
                        </div>
                    </div>
                </div>

                <!-- Calendario Principale -->
                <div class="card">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header">Sab</div>
                            <div class="calendar-day-header">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Giorni generati dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Statistiche Mensili -->
                <div class="card">
                    <h3>üìä Statistiche del Mese</h3>
                    <div class="form-row">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-light);" id="monthSessions">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni Totali</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary-color);" id="monthHours">0h</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ore di Studio</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="monthDays">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Giorni Attivi</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);" id="monthAverage">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Media Sessioni/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Statistiche -->
            <section id="statistiche" class="section">
                <div class="card">
                    <h3>üìä Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Nessuna statistica disponibile.</p>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <!-- Sezione Produttivit√† -->
                <div class="card">
                    <h3>üìä La Tua Produttivit√†</h3>
                    
                    <!-- Heatmap 24 ore -->
                    <div class="hourly-heatmap">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">üî• Heatmap Oraria della Produttivit√†</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Visualizza i tuoi momenti pi√π produttivi durante la giornata
                        </p>
                        <div class="heatmap-grid" id="heatmapGrid">
                            <!-- Celle generate dinamicamente per ogni ora (0-23) -->
                        </div>
                        <div class="heatmap-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-empty);"></div>
                                <span>Nessun dato</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-low);"></div>
                                <span>Bassa</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                                <span>Media</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-high);"></div>
                                <span>Alta</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-very-high);"></div>
                                <span>Eccellente</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Ore Migliori -->
                    <div class="top-hours-section">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">üèÜ Le Tue Top 3 Ore Migliori</h4>
                        <div class="top-hours-grid" id="topHoursGrid">
                            <!-- Top ore generate dinamicamente -->
                        </div>
                        
                        <!-- Suggerimento AI -->
                        <div class="productivity-suggestion" id="productivitySuggestion">
                            <h4>üí° Suggerimento Smart</h4>
                            <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi√π produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode" id="focusMode">
        <button class="close-focus" onclick="toggleFocusMode()">‚úï</button>
        <div class="focus-content">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">üéØ Modalit√† Focus</h2>
            <div class="focus-timer" id="focusTimer">25:00</div>
            <p style="font-size: 1.2rem; opacity: 0.8;">Resta concentrato! Stai facendo un ottimo lavoro.</p>
        </div>
    </div>

    <!-- Modal Rating Post-Sessione con Note -->
    <div class="modal-overlay" id="ratingModal">
        <div class="rating-modal">
            <h3>üéâ Sessione Completata!</h3>
            <p>Come ti senti dopo questa sessione di studio?<br>La tua valutazione ci aiuta a ottimizzare i tuoi orari migliori.</p>
            
            <div class="form-group">
                <label for="sessionNote">üìù Note sulla sessione (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Ho studiato il capitolo 3..." style="margin-bottom: 1rem;">
            </div>
            
            <div class="rating-buttons">
                <div class="rating-btn sleepy" onclick="submitRating(1)">
                    <div class="rating-emoji">üò¥</div>
                    <div class="rating-label">Stanco</div>
                </div>
                <div class="rating-btn neutral" onclick="submitRating(2)">
                    <div class="rating-emoji">üòê</div>
                    <div class="rating-label">Normale</div>
                </div>
                <div class="rating-btn good" onclick="submitRating(3)">
                    <div class="rating-emoji">üòä</div>
                    <div class="rating-label">Bene</div>
                </div>
                <div class="rating-btn excellent" onclick="submitRating(4)">
                    <div class="rating-emoji">üî•</div>
                    <div class="rating-label">Eccellente</div>
                </div>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                Clicca per salvare automaticamente
            </p>
        </div>
    </div>

    <!-- Modal per Timer Personalizzato -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3>‚öôÔ∏è Personalizza Timer</h3>
            <div class="form-group">
                <label for="customWorkTime">Minuti di Lavoro (1-180):</label>
                <input type="number" id="customWorkTime" min="1" max="180" value="25">
            </div>
            <div class="form-group">
                <label for="customBreakTime">Minuti di Pausa (1-60):</label>
                <input type="number" id="customBreakTime" min="1" max="60" value="5">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyCustomTimer()">‚úÖ Applica</button>
                <button class="btn btn-secondary" onclick="closeCustomTimerModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Sessione Manuale -->
    <div class="modal-overlay" id="addSessionModal">
        <div class="add-session-modal">
            <h3>‚ûï Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label for="sessionMateria">Materia (opzionale):</label>
                <select id="sessionMateria">
                    <option value="">Sessione generica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sessionDuration">Durata (minuti):</label>
                <input type="number" id="sessionDuration" min="5" max="300" value="25">
            </div>
            <div class="form-group">
                <label for="manualSessionNote">Note (opzionale):</label>
                <input type="text" id="manualSessionNote" placeholder="Es. Ripasso capitolo 3">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveManualSession()">‚úÖ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSessionModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Giorno Specifico -->
    <div class="modal-overlay" id="dayDetailModal">
        <div class="day-detail-modal">
            <h3 id="dayDetailTitle">üìÖ Dettagli Giorno</h3>
            <div id="dayDetailContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDayDetailModal()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="recoveryModal">
        <div class="modal">
            <h3>üîß Opzioni Recupero</h3>
            <div class="form-group">
                <label>Strategia di Recupero:</label>
                <select id="recoveryStrategy">
                    <option value="graduale">Graduale (distribuisci su 7 giorni)</option>
                    <option value="intensivo">Intensivo (recupera in 2-3 giorni)</option>
                    <option value="weekend">Weekend (solo sabato e domenica)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyRecoveryStrategy()">‚úÖ Applica</button>
                <button class="btn btn-secondary" onclick="closeRecoveryModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Tooltip per heatmap -->
    <div class="tooltip" id="heatmapTooltip"></div>

    <script>
        // === STATO GLOBALE APPLICAZIONE ===
        let materie = JSON.parse(localStorage.getItem('materie')) || [];
        let currentCalendarDate = new Date();
        let calendarSessions = JSON.parse(localStorage.getItem('calendarSessions')) || {};
        let sessionRatings = JSON.parse(localStorage.getItem('sessionRatings')) || {};
        let difficoltaSelezionata = 3;
        let timerInterval = null;
        let selectedTaskOption = null;
        let currentSessionStartTime = null;
        let currentSessionData = null;

        // Task micro universali anti-procrastinazione
        const universalMicroTasks = [
            { text: "üìñ Leggi il sommario del primo capitolo", durata: 5 },
            { text: "‚úèÔ∏è Scrivi 3 concetti che gi√† conosci dell'argomento", durata: 3 },
            { text: "üìù Prepara il materiale di studio sulla scrivania", durata: 2 },
            { text: "üéØ Definisci 1 obiettivo specifico per oggi", durata: 2 },
            { text: "üìä Controlla il tuo progresso attuale", durata: 3 },
            { text: "üîç Cerca 1 video introduttivo sull'argomento", durata: 5 },
            { text: "üìã Crea una lista di 3 domande da fare", durata: 4 },
            { text: "‚ö° Fai 10 respiri profondi per concentrarti", durata: 1 }
        ];
        
        let timerState = {
            minutes: 25,
            seconds: 0,
            isRunning: false,
            isBreak: false,
            workTime: 25,
            breakTime: 5,
            sessionsToday: parseInt(localStorage.getItem('sessionsToday')) || 0,
            lastSessionDate: localStorage.getItem('lastSessionDate') || '',
            dailyGoal: parseInt(localStorage.getItem('dailyGoal')) || 8
        };

        let studyData = {
            streak: parseInt(localStorage.getItem('studyStreak')) || 0,
            lastStudyDate: localStorage.getItem('lastStudyDate') || '',
            totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
            missedTime: parseInt(localStorage.getItem('missedTime')) || 0
        };

        // Array per salvare le sessioni dettagliate di oggi
        let todayDetailedSessions = JSON.parse(localStorage.getItem('todayDetailedSessions')) || [];

        // Sistema Rating Sessioni con gestione errori migliorata
        function showRatingModal() {
            try {
                const modal = document.getElementById('ratingModal');
                if (!modal) {
                    console.error('Rating modal not found');
                    return;
                }
                
                // Resetta la nota
                const noteInput = document.getElementById('sessionNote');
                if (noteInput) noteInput.value = '';
                
                modal.style.display = 'flex';
                
                // Suono di notifica
                playNotificationSound();
                
                // Notifica browser se supportata
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('üéâ Sessione completata!', { 
                        body: 'Come ti senti? Valuta la tua produttivit√†.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><text y="32" font-size="32">üçÖ</text></svg>'
                    });
                }
            } catch (error) {
                console.error('Errore nella visualizzazione del modal rating:', error);
                // Fallback: mostra il messaggio di completamento sessione senza modal
                showSuccessMessage('üéâ Sessione completata! Ottimo lavoro!');
            }
        }

        function submitRating(rating) {
            try {
                const now = new Date();
                const hour = now.getHours();
                
                // FIXED per timezone Italia/Napoli - usa data locale
                const dateKey = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
                const timestamp = now.getTime();
                
                // Ottieni la nota dalla sessione
                const noteInput = document.getElementById('sessionNote');
                const sessionNote = noteInput ? noteInput.value.trim() : '';
                
                // Salva rating con timestamp e ora
                if (!sessionRatings[dateKey]) {
                    sessionRatings[dateKey] = {};
                }
                
                if (!sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour] = [];
                }
                
                sessionRatings[dateKey][hour].push({
                    rating: rating,
                    timestamp: timestamp,
                    duration: timerState.workTime,
                    note: sessionNote
                });
                
                localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                
                // Salva sessione dettagliata per la lista di oggi
                const sessionDetails = {
                    id: timestamp,
                    startTime: currentSessionStartTime ? currentSessionStartTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    endTime: now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    duration: timerState.workTime,
                    rating: rating,
                    note: sessionNote,
                    materia: currentSessionData?.materia || 'Studio generale',
                    date: dateKey
                };
                
                todayDetailedSessions.push(sessionDetails);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna lista sessioni
                updateTodaySessionsList();
                
                // Chiudi modal con animazione
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Aggiorna heatmap e statistiche
                updateHeatmap();
                updateProductivitySection();
                
                // Feedback visivo
                const ratingTexts = ['üò¥ Riposa un po\'', 'üòê Va bene cos√¨', 'üòä Ottimo lavoro!', 'üî• Sei in fiammata!'];
                showSuccessMessage(`${ratingTexts[rating-1]} Rating salvato per le ${hour}:00`);
                
                console.log(`Rating salvato: ${rating}/4 alle ${hour}:00`);
            } catch (error) {
                console.error('Errore nel salvataggio rating:', error);
                showSuccessMessage('‚ö†Ô∏è Errore nel salvataggio del rating, ma sessione completata!');
                
                // Chiudi comunque il modal
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // === LISTA SESSIONI DI OGGI ===
        function updateTodaySessionsList() {
            const container = document.getElementById('todaySessionsList');
            if (!container) return;
            
            // FIXED per timezone Italia - usa data locale
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
            const lastSessionDate = localStorage.getItem('lastDetailedSessionDate') || '';
            
            if (lastSessionDate !== today) {
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                localStorage.setItem('lastDetailedSessionDate', today);
            }
            
            if (todayDetailedSessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üçÖ</div>
                        <p>Nessuna sessione completata oggi.</p>
                        <p>Avvia una sessione per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            // Ordina le sessioni per ora di inizio (pi√π recenti prima)
            const sortedSessions = [...todayDetailedSessions].sort((a, b) => b.id - a.id);
            
            container.innerHTML = sortedSessions.map(session => {
                const ratingStars = '‚òÖ'.repeat(session.rating) + '‚òÜ'.repeat(4 - session.rating);
                
                return `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-time">${session.startTime} - ${session.endTime}</div>
                            <div>
                                <span class="session-materia">${session.materia}</span>
                                <span style="color: var(--text-secondary); margin-left: 1rem;">${session.duration} min</span>
                            </div>
                            ${session.note ? `<div class="session-note">"${session.note}"</div>` : ''}
                            <div class="session-rating">
                                <span style="color: #fbbf24; font-size: 0.9rem;">${ratingStars}</span>
                            </div>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteSpecificSession(${session.id})" title="Elimina questa sessione">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteSpecificSession(sessionId) {
            try {
                // Trova la sessione da eliminare
                const sessionIndex = todayDetailedSessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    showSuccessMessage('‚ùå Sessione non trovata');
                    return;
                }
                
                const session = todayDetailedSessions[sessionIndex];
                
                const conferma = confirm(`Sei sicuro di voler eliminare questa sessione?\n\n` +
                    `Materia: ${session.materia}\n` +
                    `Durata: ${session.duration} min\n` +
                    `Orario: ${session.startTime} - ${session.endTime}\n` +
                    `Rating: ${'‚òÖ'.repeat(session.rating)}${'‚òÜ'.repeat(4 - session.rating)}\n` +
                    `${session.note ? `Nota: ${session.note}` : ''}`);
                
                if (!conferma) return;
                
                // Rimuovi dalla lista dettagliata
                todayDetailedSessions.splice(sessionIndex, 1);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna contatori generali
                if (timerState.sessionsToday > 0) {
                    timerState.sessionsToday--;
                    localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                }
                
                if (studyData.totalSessions > 0) {
                    studyData.totalSessions--;
                    localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                }
                
                // Rimuovi dal rating se esiste
                const sessionHour = parseInt(session.startTime.split(':')[0]);
                const dateKey = session.date;
                
                if (sessionRatings[dateKey] && sessionRatings[dateKey][sessionHour]) {
                    const ratingIndex = sessionRatings[dateKey][sessionHour].findIndex(r => r.timestamp === session.id);
                    if (ratingIndex !== -1) {
                        sessionRatings[dateKey][sessionHour].splice(ratingIndex, 1);
                        if (sessionRatings[dateKey][sessionHour].length === 0) {
                            delete sessionRatings[dateKey][sessionHour];
                        }
                        localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                    }
                }
                
                // Aggiorna anche il calendario
                const today = new Date().toISOString().split('T')[0];
                if (calendarSessions[today] && calendarSessions[today].completed > 0) {
                    calendarSessions[today].completed--;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(`‚úÖ Sessione di ${session.duration} min eliminata`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione della sessione:', error);
                showSuccessMessage('‚ùå Errore nell\'eliminazione della sessione');
            }
        }

        function showDeleteAllTodaySessionsModal() {
            if (todayDetailedSessions.length === 0) {
                showSuccessMessage('‚ùå Nessuna sessione da eliminare oggi');
                return;
            }
            
            const totalMinutes = todayDetailedSessions.reduce((sum, session) => sum + session.duration, 0);
            
            const conferma = confirm(`Sei sicuro di voler eliminare tutte le ${todayDetailedSessions.length} sessioni di oggi?\n\n` +
                `Tempo totale: ${totalMinutes} minuti\n` +
                `Questa azione non pu√≤ essere annullata.`);
            
            if (!conferma) return;
            
            try {
                // Azzera tutto
                const sessionsDeleted = todayDetailedSessions.length;
                
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                timerState.sessionsToday = 0;
                localStorage.setItem('sessionsToday', '0');
                
                studyData.totalSessions = Math.max(0, studyData.totalSessions - sessionsDeleted);
                localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                
                // Pulisci anche i rating di oggi
                const today = new Date().toISOString().split('T')[0];
                if (sessionRatings[today]) {
                    delete sessionRatings[today];
                    localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                }
                
                // Pulisci calendario di oggi
                if (calendarSessions[today]) {
                    calendarSessions[today].completed = 0;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(`‚úÖ Tutte le ${sessionsDeleted} sessioni di oggi sono state eliminate`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione di tutte le sessioni:', error);
                showSuccessMessage('‚ùå Errore nell\'eliminazione delle sessioni');
            }
        }

        // === HEATMAP 24 ORE ===
        function initializeHeatmap() {
            const heatmapGrid = document.getElementById('heatmapGrid');
            if (!heatmapGrid) return;
            
            heatmapGrid.innerHTML = '';
            
            // Genera 24 celle (0-23 ore)
            for (let hour = 0; hour < 24; hour++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell empty';
                cell.textContent = hour.toString().padStart(2, '0');
                cell.dataset.hour = hour;
                
                // Event listeners per tooltip
                cell.addEventListener('mouseenter', (e) => showHeatmapTooltip(e, hour));
                cell.addEventListener('mouseleave', hideHeatmapTooltip);
                
                heatmapGrid.appendChild(cell);
            }
            
            updateHeatmap();
        }

        function updateHeatmap() {
            const cells = document.querySelectorAll('.heatmap-cell');
            
            cells.forEach((cell, hour) => {
                const avgRating = calculateHourlyAverageRating(hour);
                
                // Reset classi
                cell.className = 'heatmap-cell';
                
                if (avgRating === 0) {
                    cell.classList.add('empty');
                } else if (avgRating <= 1.5) {
                    cell.classList.add('low');
                } else if (avgRating <= 2.5) {
                    cell.classList.add('medium');
                } else if (avgRating <= 3.5) {
                    cell.classList.add('high');
                } else {
                    cell.classList.add('very-high');
                }
            });
        }

        function calculateHourlyAverageRating(hour) {
            let totalRating = 0;
            let sessionCount = 0;
            
            // Analizza gli ultimi 30 giorni
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour].forEach(session => {
                        totalRating += session.rating;
                        sessionCount++;
                    });
                }
            });
            
            return sessionCount > 0 ? totalRating / sessionCount : 0;
        }

        function showHeatmapTooltip(event, hour) {
            const tooltip = document.getElementById('heatmapTooltip');
            if (!tooltip) return;
            
            const avgRating = calculateHourlyAverageRating(hour);
            const sessionCount = getHourlySessionCount(hour);
            
            let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
            
            if (sessionCount === 0) {
                content += 'Nessuna sessione registrata';
            } else {
                const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                 avgRating <= 2.5 ? 'Media' : 
                                 avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                content += `Produttivit√†: ${ratingText}<br>`;
                content += `${sessionCount} sessioni<br>`;
                content += `Rating medio: ${avgRating.toFixed(1)}/4`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideHeatmapTooltip() {
            const tooltip = document.getElementById('heatmapTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        function getHourlySessionCount(hour) {
            let sessionCount = 0;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionCount += sessionRatings[dateKey][hour].length;
                }
            });
            
            return sessionCount;
        }

        // === SEZIONE PRODUTTIVIT√Ä ===
        function updateProductivitySection() {
            updateTopHours();
            updateProductivitySuggestion();
        }

        function updateTopHours() {
            const topHoursGrid = document.getElementById('topHoursGrid');
            if (!topHoursGrid) return;
            
            // Calcola rating medio per ogni ora
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            // Ordina per rating e prendi i top 3
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const top3 = hourlyRatings.slice(0, 3);
            
            if (top3.length === 0) {
                topHoursGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                        <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                    </div>
                `;
                return;
            }
            
            topHoursGrid.innerHTML = top3.map((hour, index) => {
                const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                  hour.avgRating <= 2.5 ? 'Media' : 
                                  hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                
                const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
                
                return `
                    <div class="top-hour-item">
                        <div class="top-hour-rank">${rankEmojis[index]}</div>
                        <div class="top-hour-time">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                        <div class="top-hour-rating">
                            ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                            <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProductivitySuggestion() {
            const suggestionEl = document.getElementById('productivitySuggestion');
            if (!suggestionEl) return;
            
            // Calcola statistics per il suggerimento
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            if (hourlyRatings.length === 0) {
                suggestionEl.innerHTML = `
                    <h4>üí° Suggerimento Smart</h4>
                    <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi√π produttivi!</p>
                `;
                return;
            }
            
            // Trova le ore migliori
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const bestHours = hourlyRatings.slice(0, 3);
            
            // Genera suggerimento personalizzato
            let suggestion = '';
            if (bestHours.length >= 2) {
                const topHour = bestHours[0];
                const secondHour = bestHours[1];
                
                const materieComplesse = materie.filter(m => m.difficolta >= 4);
                
                if (materieComplesse.length > 0) {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Perfette per ${materieComplesse[0].nome} che richiede maggiore concentrazione!`;
                } else {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Programma le sessioni pi√π impegnative in questi orari.`;
                }
            } else {
                const topHour = bestHours[0];
                suggestion = `La tua ora migliore √® ${topHour.hour}:00-${topHour.hour + 1}:00 con un rating medio di ${topHour.avgRating.toFixed(1)}/4. 
                    Concentra qui le attivit√† pi√π difficili!`;
            }
            
            suggestionEl.innerHTML = `
                <h4>üí° Suggerimento Smart</h4>
                <p>${suggestion}</p>
            `;
        }

        // === NAVIGAZIONE ===
        function showSection(sectionName, targetElement) {
            try {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });

                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                if (targetElement) {
                    targetElement.classList.add('active');
                }

                // Aggiorna contenuto dinamico
                if (sectionName === 'oggi') {
                    generateTodaySchedule();
                } else if (sectionName === 'piano') {
                    generatePianoStudio();
                } else if (sectionName === 'statistiche') {
                    updateStatistiche();
                    updateHeatmap();
                    updateProductivitySection();
                } else if (sectionName === 'calendario') {
                    renderCalendar();
                } else if (sectionName === 'materie') {
                    setTimeout(() => {
                        initializeWeeklySlots();
                        setupStarRating();
                    }, 100);
                } else if (sectionName === 'pomodoro') {
                    updateTodaySessionsList();
                }

            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // === OBIETTIVO GIORNALIERO PERSONALIZZABILE ===
        function updateDailyGoal() {
            const goalInput = document.getElementById('dailyGoal');
            const newGoal = parseInt(goalInput.value);
            
            if (newGoal && newGoal > 0 && newGoal <= 20) {
                timerState.dailyGoal = newGoal;
                localStorage.setItem('dailyGoal', newGoal.toString());
                updateSessionDisplay();
                updateDailyGoalDisplay();
                showSuccessMessage(`üéØ Obiettivo aggiornato: ${newGoal} pomodori al giorno`);
            } else {
                goalInput.value = timerState.dailyGoal;
                showSuccessMessage('‚ùå Inserisci un obiettivo valido (1-20 sessioni)');
            }
        }

        function updateDailyGoalDisplay() {
            const goalInput = document.getElementById('dailyGoal');
            const sessionGoalEl = document.getElementById('sessionGoal');
            const goalTodayEl = document.getElementById('goalToday');
            const completedTodayEl = document.getElementById('completedToday');
            const remainingTodayEl = document.getElementById('remainingToday');
            
            if (goalInput) goalInput.value = timerState.dailyGoal;
            if (sessionGoalEl) sessionGoalEl.textContent = timerState.dailyGoal;
            if (goalTodayEl) goalTodayEl.textContent = timerState.dailyGoal;
            if (completedTodayEl) completedTodayEl.textContent = timerState.sessionsToday;
            if (remainingTodayEl) remainingTodayEl.textContent = Math.max(0, timerState.dailyGoal - timerState.sessionsToday);
        }

        // === SISTEMA SLOT TEMPORALI ===
        function initializeWeeklySlots() {
            const container = document.getElementById('weeklySlots');
            if (!container) {
                console.error('Container weeklySlots non trovato!');
                return;
            }
            
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const giorniLabel = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];

            const slotsHTML = giorni.map((giorno, index) => `
                <div class="day-slots">
                    <h4>${giorniLabel[index]}</h4>
                    <div class="time-slots" id="slots-${giorno}">
                        <button type="button" class="add-slot" onclick="addTimeSlot('${giorno}')">+ Aggiungi Slot</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = slotsHTML;
            console.log('Slot temporali inizializzati correttamente');
        }

        function addTimeSlot(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) {
                console.error(`Container slots-${giorno} non trovato!`);
                return;
            }
            
            const slotId = `${giorno}-${Date.now()}`;
            
            const slotHTML = `
                <div class="slot-item" id="${slotId}">
                    <input type="time" value="09:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <span style="color: var(--text-secondary); margin: 0 0.5rem;">-</span>
                    <input type="time" value="11:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <button type="button" class="remove-slot" onclick="removeTimeSlot('${slotId}', '${giorno}')" title="Rimuovi slot">√ó</button>
                </div>
            `;
            
            const addButton = container.querySelector('.add-slot');
            if (addButton) {
                addButton.insertAdjacentHTML('beforebegin', slotHTML);
                console.log(`Slot aggiunto per ${giorno}`);
            } else {
                console.error(`Pulsante add-slot non trovato per ${giorno}`);
            }
        }

        function removeTimeSlot(slotId, giorno) {
            const slot = document.getElementById(slotId);
            if (slot) {
                slot.remove();
                validateSlots(giorno);
            }
        }

        function validateSlots(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) return true;
            
            const slots = container.querySelectorAll('.slot-item');
            
            const timeRanges = [];
            let hasOverlap = false;

            slots.forEach(slot => {
                const inputs = slot.querySelectorAll('input[type="time"]');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                // Reset stili
                inputs.forEach(input => {
                    input.style.borderColor = 'var(--border-color)';
                });

                if (start && end) {
                    if (start >= end) {
                        // Orario di fine deve essere dopo l'inizio
                        inputs.forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    } else {
                        timeRanges.push({ start, end, element: slot });
                    }
                }
            });

            // Controlla sovrapposizioni tra slot
            for (let i = 0; i < timeRanges.length; i++) {
                for (let j = i + 1; j < timeRanges.length; j++) {
                    const range1 = timeRanges[i];
                    const range2 = timeRanges[j];
                    
                    if (timeOverlap(range1.start, range1.end, range2.start, range2.end)) {
                        range1.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        range2.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    }
                }
            }

            return !hasOverlap;
        }

        function timeOverlap(start1, end1, start2, end2) {
            return (start1 < end2) && (end1 > start2);
        }

        function getWeeklySlots() {
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const slotSettimanali = {};

            giorni.forEach(giorno => {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) {
                    slotSettimanali[giorno] = [];
                    return;
                }
                
                const slots = container.querySelectorAll('.slot-item');
                slotSettimanali[giorno] = [];

                slots.forEach(slot => {
                    const inputs = slot.querySelectorAll('input[type="time"]');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    if (start && end && start < end) {
                        slotSettimanali[giorno].push({
                            inizio: start,
                            fine: end,
                            disponibile: true
                        });
                    }
                });
            });

            return slotSettimanali;
        }

        // === SMART SCHEDULER CON OPZIONI PERSONALIZZABILI ===
        function generateTodaySchedule() {
            if (materie.length === 0) {
                updateTodayDisplay(null, []);
                return;
            }

            const oggi = new Date();
            const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
            
            // Genera il piano smart per oggi
            const scheduleOggi = generateSmartSchedule(giornoSettimana);
            
            updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
            updateMicroTasks(scheduleOggi.nextTask);
            updateRecoveryDashboard();
        }

        function generateSmartSchedule(giornoSettimana) {
            const materieFiltrate = materie.filter(materia => {
                const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                return slots && slots.length > 0;
            });

            if (materieFiltrate.length === 0) {
                return { nextTask: null, timeline: [] };
            }

            const timeline = [];
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Ordina materie per priorit√† e urgenza
            const materiePrioritarie = materieFiltrate.sort((a, b) => {
                const urgenzaA = calcolaPianoMateria(a).urgenza;
                const urgenzaB = calcolaPianoMateria(b).urgenza;
                const priorityOrder = { 'critica': 4, 'alta': 3, 'moderata': 2, 'normale': 1 };
                
                return (priorityOrder[urgenzaB] || 0) - (priorityOrder[urgenzaA] || 0);
            });

            let nextTask = null;

            materiePrioritarie.forEach(materia => {
                const slots = materia.slotSettimanali[giornoSettimana] || [];
                
                slots.forEach(slot => {
                    if (slot.disponibile) {
                        const durata = calculateTaskDuration(slot.inizio, slot.fine);
                        
                        const task = {
                            materia: materia.nome,
                            durata: durata,
                            orarioInizio: slot.inizio,
                            orarioFine: slot.fine,
                            difficolta: materia.difficolta,
                            pagineRimanenti: Math.max(0, materia.pagine - (materia.pagineStudiate || 0)),
                            percentualeCompletamento: ((materia.pagineStudiate || 0) / materia.pagine) * 100,
                            opzioni: generateTaskOptions(materia)
                        };

                        timeline.push(task);

                        // Il primo task futuro diventa il prossimo task
                        if (!nextTask && slot.inizio > currentTime) {
                            nextTask = task;
                        }
                    }
                });
            });

            // Se non ci sono task futuri, prendi il primo disponibile
            if (!nextTask && timeline.length > 0) {
                nextTask = timeline[0];
            }

            return { nextTask, timeline: timeline.sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio)) };
        }

        // Genera opzioni personalizzabili per ogni task
        function generateTaskOptions(materia) {
            const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
            const options = [];

            // Opzioni basate sul progresso
            if (percentualeCompletamento < 30) {
                options.push({
                    id: 'concetti-base',
                    titulo: 'üìö Concetti Base',
                    descrizione: 'Inizia con i fondamenti e le definizioni principali',
                    motivazione: 'Costruire basi solide √® essenziale per il successo'
                });
                options.push({
                    id: 'primi-capitoli',
                    titulo: 'üìñ Primi Capitoli',
                    descrizione: 'Studio sequenziale dall\'inizio del programma',
                    motivazione: 'Approccio sistematico per una comprensione completa'
                });
            }

            if (percentualeCompletamento >= 20) {
                options.push({
                    id: 'approfondimento',
                    titulo: 'üîç Approfondimento',
                    descrizione: 'Continua con gli argomenti pi√π complessi',
                    motivazione: 'Sviluppa una comprensione pi√π profonda della materia'
                });
                options.push({
                    id: 'esercizi',
                    titulo: 'üí™ Esercizi Pratici',
                    descrizione: 'Risolvi problemi ed esercizi applicativi',
                    motivazione: 'La pratica consolida la teoria appresa'
                });
            }

            if (percentualeCompletamento >= 50) {
                options.push({
                    id: 'ripasso',
                    titulo: 'üîÑ Ripasso Generale',
                    descrizione: 'Rivedi e consolida gli argomenti gi√† studiati',
                    motivazione: 'Il ripasso rafforza la memoria a lungo termine'
                });
                options.push({
                    id: 'argomenti-specifici',
                    titulo: 'üéØ Argomenti Specifici',
                    descrizione: 'Concentrati su capitoli o teoremi particolari',
                    motivazione: 'Personalizza il tuo studio in base alle tue esigenze'
                });
            }

            // Opzioni sempre disponibili
            options.push({
                id: 'simulazione-esame',
                titulo: 'üìù Simulazione Esame',
                descrizione: 'Pratica con domande e prove d\'esame simulate',
                motivazione: 'Preparati al formato e al ritmo dell\'esame reale'
            });

            options.push({
                id: 'personalizzato',
                titulo: '‚öôÔ∏è Studio Personalizzato',
                descrizione: 'Scegli tu cosa studiare in questa sessione',
                motivazione: 'Tu conosci meglio le tue necessit√† del momento'
            });

            return options;
        }

        function calculateTaskDuration(inizio, fine) {
            const start = new Date(`1970-01-01T${inizio}:00`);
            const end = new Date(`1970-01-01T${fine}:00`);
            return Math.round((end - start) / (1000 * 60)); // in minuti
        }

        function updateTodayDisplay(nextTask, timeline) {
            const currentTaskMateria = document.getElementById('currentTaskMateria');
            const currentTaskTime = document.getElementById('currentTaskTime');
            const currentTaskDesc = document.getElementById('currentTaskDesc');
            const currentTaskMotivation = document.getElementById('currentTaskMotivation');
            const taskOptions = document.getElementById('taskOptions');
            const taskOptionsList = document.getElementById('taskOptionsList');
            const startTaskBtn = document.getElementById('startTaskBtn');
            const timelineContainer = document.getElementById('timelineOggi');

            if (!nextTask) {
                currentTaskMateria.textContent = 'Nessun task programmato';
                currentTaskTime.textContent = '‚è±Ô∏è -- min';
                currentTaskDesc.textContent = 'Aggiungi slot temporali alle tue materie per vedere il piano giornaliero!';
                currentTaskMotivation.textContent = 'üí° Definisci quando puoi studiare per ottimizzare la tua giornata';
                taskOptions.style.display = 'none';
                startTaskBtn.disabled = true;
                
                timelineContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                    </div>
                `;
                return;
            }

            // Aggiorna task corrente
            currentTaskMateria.textContent = nextTask.materia;
            currentTaskTime.textContent = `‚è±Ô∏è ${nextTask.durata} min`;
            
            // Mostra opzioni personalizzabili
            if (nextTask.opzioni && nextTask.opzioni.length > 0) {
                taskOptions.style.display = 'block';
                taskOptionsList.innerHTML = nextTask.opzioni.map(opzione => `
                    <button class="task-option-btn" onclick="selectTaskOption('${opzione.id}', '${nextTask.materia}', this)">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${opzione.titulo}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${opzione.descrizione}</div>
                        <div style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">üí° ${opzione.motivazione}</div>
                    </button>
                `).join('');
                
                // Seleziona automaticamente la prima opzione
                if (!selectedTaskOption) {
                    selectTaskOption(nextTask.opzioni[0].id, nextTask.materia);
                }
            } else {
                taskOptions.style.display = 'none';
            }

            startTaskBtn.disabled = false;

            // Aggiorna timeline
            if (timeline.length === 0) {
                timelineContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Nessun task programmato per oggi</p>
                    </div>
                `;
            } else {
                timelineContainer.innerHTML = timeline.map(task => `
                    <div class="timeline-item">
                        <div class="timeline-time">${task.orarioInizio}</div>
                        <div class="timeline-content">
                            <strong>${task.materia}</strong><br>
                            <span style="opacity: 0.8;">Slot di studio programmato</span><br>
                            <small style="color: var(--secondary-color);">${task.durata} min ‚Ä¢ ${Math.round(task.percentualeCompletamento)}% completato</small>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Gestione selezione opzioni task
        function selectTaskOption(optionId, materia, clickedElement) {
            selectedTaskOption = optionId;
            currentSessionData = { materia: materia, option: optionId };
            
            // Aggiorna UI
            document.querySelectorAll('.task-option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Se abbiamo l'elemento cliccato, usalo; altrimenti trova il pulsante per ID
            if (clickedElement) {
                clickedElement.classList.add('selected');
            } else {
                // Fallback: trova il pulsante che contiene l'optionId
                const buttons = document.querySelectorAll('.task-option-btn');
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(optionId)) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            // Trova l'opzione selezionata
            const currentTask = getCurrentNextTask();
            if (currentTask && currentTask.opzioni) {
                const selectedOption = currentTask.opzioni.find(opt => opt.id === optionId);
                if (selectedOption) {
                    document.getElementById('currentTaskDesc').textContent = selectedOption.descrizione;
                    document.getElementById('currentTaskMotivation').textContent = `üí° ${selectedOption.motivazione}`;
                }
            }
        }

        function updateMicroTasks(nextTask) {
            const microTasksContainer = document.getElementById('microTasks');
            const microTasksList = document.getElementById('microTasksList');

            if (!nextTask) {
                microTasksContainer.style.display = 'none';
                return;
            }

            // Usa i micro task universali
            const tasks = universalMicroTasks.slice(0, 4); // Prendi i primi 4
            microTasksContainer.style.display = 'block';
            
            microTasksList.innerHTML = tasks.map(task => `
                <div class="micro-task-item" onclick="startMicroTask('${task.text}', ${task.durata}, this)">
                    <div>${task.text}</div>
                    <div class="micro-task-duration">${task.durata} min</div>
                </div>
            `).join('');
        }

        function startMicroTask(taskText, durata, clickedElement) {
            currentSessionData = { materia: 'Micro-task', option: taskText };
            setPreset(durata, Math.max(2, Math.floor(durata / 5)), null);
            showSuccessMessage(`üöÄ Micro-task avviato: ${taskText}`);
            
            // Evidenzia visivamente il micro-task selezionato
            if (clickedElement) {
                document.querySelectorAll('.micro-task-item').forEach(item => {
                    item.style.transform = 'translateX(0)';
                    item.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                });
                clickedElement.style.transform = 'translateX(8px)';
                clickedElement.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
            }
            
            startTimer();
        }

        function iniziaTask() {
            const nextTask = getCurrentNextTask();
            if (nextTask) {
                const taskDuration = Math.min(50, nextTask.durata);
                const breakDuration = Math.max(5, Math.floor(taskDuration / 10));
                
                setPreset(taskDuration, breakDuration, null);
                
                const selectedOptionText = selectedTaskOption ? 
                    ` (${document.querySelector('.task-option-btn.selected')?.textContent.split('\n')[0] || 'Studio'})` : '';
                
                showSuccessMessage(`üöÄ Task avviato: ${nextTask.materia}${selectedOptionText} per ${taskDuration} minuti`);
                startTimer();
            }
        }

        function getCurrentNextTask() {
            const oggi = new Date();
            const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
            const schedule = generateSmartSchedule(giornoSettimana);
            return schedule.nextTask;
        }

        // === SISTEMA RECUPERO GRADUALE ===
        function updateRecoveryDashboard() {
            const recoveryDashboard = document.getElementById('recoveryDashboard');
            const missedTimeEl = document.getElementById('missedTime');
            const recoveryPlanEl = document.getElementById('recoveryPlan');

            if (studyData.missedTime <= 0) {
                recoveryDashboard.style.display = 'none';
                return;
            }

            recoveryDashboard.style.display = 'block';
            const hours = Math.floor(studyData.missedTime / 60);
            const minutes = studyData.missedTime % 60;
            missedTimeEl.textContent = `${hours}h ${minutes}min`;

            const minutiExtraPerGiorno = Math.ceil(studyData.missedTime / 7);
            recoveryPlanEl.textContent = `Piano: +${minutiExtraPerGiorno} min/giorno per 7 giorni`;
        }

        function showRecoveryOptions() {
            const modal = document.getElementById('recoveryModal');
            modal.style.display = 'flex';
        }

        function closeRecoveryModal() {
            const modal = document.getElementById('recoveryModal');
            modal.style.display = 'none';
        }

        function applyRecoveryStrategy() {
            const strategy = document.getElementById('recoveryStrategy').value;
            const totalMinutes = studyData.missedTime;
            let message = '';

            switch(strategy) {
                case 'graduale':
                    message = `Distribuzione graduale: +${Math.ceil(totalMinutes/7)} min/giorno per 7 giorni`;
                    break;
                case 'intensivo':
                    message = `Recupero intensivo: +${Math.ceil(totalMinutes/3)} min/giorno per 3 giorni`;
                    break;
                case 'weekend':
                    message = `Recupero weekend: +${Math.ceil(totalMinutes/2)} min sabato e domenica`;
                    break;
            }

            showSuccessMessage(`‚úÖ ${message}`);
            closeRecoveryModal();
        }

        // === GESTIONE MATERIE ===
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                // Rimuovi event listeners esistenti per evitare duplicati
                star.replaceWith(star.cloneNode(true));
            });
            
            // Riottieni i riferimenti dopo la clonazione
            const freshStars = document.querySelectorAll('.star');
            freshStars.forEach((star, index) => {
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    difficoltaSelezionata = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
                
                star.addEventListener('mouseout', function() {
                    updateStarDisplay();
                });
            });

            updateStarDisplay();
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateStarDisplay() {
            highlightStars(difficoltaSelezionata);
        }

        function addMateria() {
            console.log('‚ûï Aggiungendo nuova materia...');

            try {
                const nome = document.getElementById('nomeMateria').value.trim();
                const cfu = document.getElementById('cfu').value;
                const pagine = document.getElementById('pagine').value;

                if (!nome || !cfu || !pagine) {
                    showSuccessMessage('‚ùå Compila tutti i campi obbligatori: Nome Materia, CFU e Pagine Totali');
                    return;
                }

                // Validazione slot temporali
                const slotSettimanali = getWeeklySlots();
                const hasSlots = Object.values(slotSettimanali).some(slots => slots.length > 0);

                if (!hasSlots) {
                    showSuccessMessage('‚ùå Aggiungi almeno uno slot temporale per programmare lo studio!');
                    return;
                }

                const materia = {
                    id: Date.now(),
                    nome: nome,
                    cfu: parseInt(cfu),
                    pagine: parseInt(pagine),
                    pagineStudiate: parseInt(document.getElementById('pagineStudiate').value) || 0,
                    pagineOra: parseInt(document.getElementById('pagineOra').value) || 8,
                    eserciziTotali: parseInt(document.getElementById('eserciziTotali').value) || 0,
                    eserciziCompletati: parseInt(document.getElementById('eserciziCompletati').value) || 0,
                    dataEsame: document.getElementById('dataEsame').value,
                    priorita: document.getElementById('priorita').value,
                    difficolta: difficoltaSelezionata,
                    slotSettimanali: slotSettimanali
                };

                materie.push(materia);
                saveMaterie();
                loadMaterie();
                generateTodaySchedule();
                generatePianoStudio();
                updateStatistiche();

                resetForm();
                showSuccessMessage('‚úÖ Materia aggiunta con successo!');
                
            } catch (error) {
                console.log('Errore nell\'aggiunta materia:', error);
                showSuccessMessage('‚ùå Errore nell\'aggiunta della materia. Riprova.');
            }
        }

        function resetForm() {
            document.getElementById('nomeMateria').value = '';
            document.getElementById('cfu').value = '';
            document.getElementById('pagine').value = '';
            document.getElementById('pagineStudiate').value = '0';
            document.getElementById('pagineOra').value = '8';
            document.getElementById('eserciziTotali').value = '0';
            document.getElementById('eserciziCompletati').value = '0';
            document.getElementById('dataEsame').value = '';
            document.getElementById('priorita').value = 'media';
            
            difficoltaSelezionata = 3;
            updateStarDisplay();

            // Reset slot temporali con delay
            setTimeout(() => {
                initializeWeeklySlots();
            }, 100);
        }

        function loadMaterie() {
            const container = document.getElementById('materieList');
            
            if (materie.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Nessuna materia aggiunta ancora.</p>
                        <p>Inizia aggiungendo la tua prima materia!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = materie.map(materia => {
                const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                const percentualeEsercizi = materia.eserciziTotali > 0 ? 
                    Math.round(((materia.eserciziCompletati || 0) / materia.eserciziTotali) * 100) : 0;
                
                // Calcola ore totali settimanali dagli slot
                let oreTotaliSettimanali = 0;
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slots.forEach(slot => {
                            const durata = calculateTaskDuration(slot.inizio, slot.fine);
                            oreTotaliSettimanali += durata;
                        });
                    });
                    oreTotaliSettimanali = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                }
                
                return `
                <div class="subject-item">
                    <div class="subject-header">
                        <div class="subject-name">${materia.nome}</div>
                        <div class="subject-actions">
                            <span class="priority-badge priority-${materia.priorita}">${materia.priorita}</span>
                            <button class="btn btn-warning" onclick="editMateria(${materia.id})" style="padding: 0.75rem;" title="Modifica materia">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteMateria(${materia.id})" style="padding: 0.75rem;" title="Elimina materia">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="subject-progress" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--primary-light);">Progresso Studio:</strong>
                            <span style="color: var(--secondary-color); font-weight: 600;">${percentualeCompletamento}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentualeCompletamento}%"></div>
                        </div>
                        <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine completate</small>
                    </div>
                    
                    ${materia.eserciziTotali > 0 ? `
                    <div class="subject-progress" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--accent-color);">Progresso Esercizi:</strong>
                            <span style="color: var(--warning-color); font-weight: 600;">${percentualeEsercizi}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentualeEsercizi}%; background: linear-gradient(90deg, var(--warning-color), var(--accent-color));"></div>
                        </div>
                        <small style="color: var(--text-secondary);">${materia.eserciziCompletati || 0}/${materia.eserciziTotali} esercizi completati</small>
                    </div>
                    ` : ''}
                    
                    <div class="subject-info">
                        <div><strong>CFU:</strong> ${materia.cfu}</div>
                        <div><strong>Pagine:</strong> ${materia.pagine}</div>
                        <div><strong>Pagine/ora:</strong> ${materia.pagineOra || 8}</div>
                        <div><strong>Ore settimanali:</strong> ${oreTotaliSettimanali}h</div>
                        ${materia.eserciziTotali > 0 ? `<div><strong>Esercizi:</strong> ${materia.eserciziCompletati || 0}/${materia.eserciziTotali}</div>` : ''}
                        <div><strong>Esame:</strong> ${materia.dataEsame ? new Date(materia.dataEsame).toLocaleDateString('it-IT') : 'Non impostato'}</div>
                        <div><strong>Difficolt√†:</strong> ${'‚òÖ'.repeat(materia.difficolta || 3)}${'‚òÜ'.repeat(5-(materia.difficolta || 3))}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function editMateria(id) {
            try {
                const materia = materie.find(m => m.id === id);
                if (!materia) {
                    showSuccessMessage('‚ùå Materia non trovata');
                    return;
                }

                // Popola il form
                document.getElementById('nomeMateria').value = materia.nome || '';
                document.getElementById('cfu').value = materia.cfu || '';
                document.getElementById('pagine').value = materia.pagine || '';
                document.getElementById('pagineStudiate').value = materia.pagineStudiate || 0;
                document.getElementById('pagineOra').value = materia.pagineOra || 8;
                document.getElementById('eserciziTotali').value = materia.eserciziTotali || 0;
                document.getElementById('eserciziCompletati').value = materia.eserciziCompletati || 0;
                document.getElementById('dataEsame').value = materia.dataEsame || '';
                document.getElementById('priorita').value = materia.priorita || 'media';
                
                difficoltaSelezionata = materia.difficolta || 3;
                updateStarDisplay();

                // Carica slot temporali esistenti
                setTimeout(() => {
                    initializeWeeklySlots();
                    
                    if (materia.slotSettimanali) {
                        setTimeout(() => {
                            Object.keys(materia.slotSettimanali).forEach(giorno => {
                                const slots = materia.slotSettimanali[giorno];
                                slots.forEach(slot => {
                                    addTimeSlot(giorno);
                                    const container = document.getElementById(`slots-${giorno}`);
                                    if (container) {
                                        const lastSlot = container.querySelector('.slot-item:last-of-type');
                                        if (lastSlot) {
                                            const inputs = lastSlot.querySelectorAll('input[type="time"]');
                                            if (inputs.length >= 2) {
                                                inputs[0].value = slot.inizio;
                                                inputs[1].value = slot.fine;
                                            }
                                        }
                                    }
                                });
                            });
                        }, 200);
                    }
                }, 100);

                // Rimuovi la materia (sar√† ri-aggiunta al salvataggio)
                materie = materie.filter(m => m.id !== id);
                saveMaterie();
                loadMaterie();

                showSection('materie', document.querySelector('.nav-tab[onclick*="materie"]'));
                showSuccessMessage('üìù Materia caricata per modifica');
                
            } catch (error) {
                console.error('‚ùå Errore nella modifica:', error);
                showSuccessMessage('‚ùå Errore nel caricamento della materia');
            }
        }

        function deleteMateria(id) {
            try {
                const materia = materie.find(m => m.id === id);
                if (!materia) {
                    showSuccessMessage('‚ùå Materia non trovata');
                    return;
                }

                const conferma = confirm(`Sei sicuro di voler eliminare "${materia.nome}"?\n\nQuesta azione non pu√≤ essere annullata.`);
                
                if (conferma) {
                    materie = materie.filter(m => m.id !== id);
                    saveMaterie();
                    loadMaterie();
                    generateTodaySchedule();
                    generatePianoStudio();
                    updateStatistiche();
                    
                    showSuccessMessage('üóëÔ∏è Materia eliminata con successo');
                }
            } catch (error) {
                console.error('‚ùå Errore nell\'eliminazione:', error);
                showSuccessMessage('‚ùå Errore nell\'eliminazione della materia');
            }
        }

        function saveMaterie() {
            try {
                localStorage.setItem('materie', JSON.stringify(materie));
            } catch (error) {
                console.error('Errore nel salvataggio:', error);
            }
        }

        // === PIANO DI STUDIO CON AI INSIGHTS ===
        function calcolaPianoMateria(materia) {
            const oggi = new Date();
            const dataEsame = materia.dataEsame ? new Date(materia.dataEsame) : new Date(oggi.getTime() + (30 * 24 * 60 * 60 * 1000));
            const giorniRimanenti = Math.ceil((dataEsame - oggi) / (1000 * 60 * 60 * 24));
            
            const oreTotaliCFU = materia.cfu * 25;
            const moltiplicatoreDifficolta = 0.7 + (materia.difficolta * 0.15);
            const oreNecessarieCFU = Math.ceil(oreTotaliCFU * moltiplicatoreDifficolta);
            
            const pagineRimanenti = Math.max(0, materia.pagine - (materia.pagineStudiate || 0));
            const pagineOra = materia.pagineOra || 8;
            const oreNecessariePagine = Math.ceil(pagineRimanenti / pagineOra);
            
            const oreNecessarie = Math.max(oreNecessarieCFU, oreNecessariePagine);
            
            // Calcola ore settimanali dagli slot
            let oreSettimanali = 0;
            if (materia.slotSettimanali) {
                Object.values(materia.slotSettimanali).forEach(slots => {
                    slots.forEach(slot => {
                        const durata = calculateTaskDuration(slot.inizio, slot.fine);
                        oreSettimanali += durata / 60;
                    });
                });
            }
            
            const settimaneRimanenti = Math.max(1, giorniRimanenti / 7);
            const oreTotaliDisponibili = Math.floor(oreSettimanali * settimaneRimanenti);
            
            const giorniEffettivi = Math.max(1, giorniRimanenti - 3);
            const giornateDiStudio = Math.floor(giorniEffettivi * 0.8);
            
            const pagineAlGiorno = Math.ceil(pagineRimanenti / Math.max(giornateDiStudio, 1));
            const oreAlGiorno = Math.ceil(pagineAlGiorno / pagineOra);
            
            const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
            
            let urgenza = 'normale';
            let raccomandazioni = [];
            
            if (giorniRimanenti <= 7) {
                urgenza = 'critica';
                raccomandazioni.push('üìö Concentrati solo sui concetti chiave');
                raccomandazioni.push('‚ö° Aumenta le ore di studio giornaliere');
                raccomandazioni.push('üéØ Usa micro-sessioni da 25-30 minuti');
            } else if (giorniRimanenti <= 21) {
                urgenza = 'alta';
                raccomandazioni.push('üéØ Pianifica sessioni di studio intensive');
                raccomandazioni.push('üìñ Focalizzati sui capitoli pi√π importanti');
            } else if (oreTotaliDisponibili < oreNecessarie) {
                urgenza = 'moderata';  
                raccomandazioni.push('‚è∞ Considera di aumentare gli slot settimanali');
                raccomandazioni.push('üîÑ Ottimizza la strategia di studio');
            }

            return {
                giorniRimanenti: Math.max(0, giorniRimanenti),
                oreTotaliDisponibili,
                oreNecessarie,
                oreNecessarieCFU,
                oreNecessariePagine,
                oreSettimanali,
                pagineRimanenti,
                percentualeCompletamento,
                pagineAlGiorno,
                oreAlGiorno,
                urgenza,
                raccomandazioni,
                warning: oreTotaliDisponibili < oreNecessarie ? 
                    `Tempo insufficiente! Servono ${Math.ceil((oreNecessarie - oreTotaliDisponibili) / Math.max(oreSettimanali, 1))} settimane in pi√π.` : null
            };
        }

        function generateAIInsights() {
            if (materie.length === 0) return { insights: [], suggestions: [] };

            const insights = [];
            const suggestions = [];
            
            // Analizza pattern di studio
            const materieDifficolta = materie.filter(m => m.difficolta >= 4);
            const materieFacili = materie.filter(m => m.difficolta <= 2);
            
            if (materieDifficolta.length > 0) {
                insights.push('üß† Hai materie impegnative: pianifica slot mattutini per massima concentrazione');
            }
            
            if (materieFacili.length > 0) {
                insights.push('‚ö° Usa le materie pi√π facili come "warm-up" prima delle sessioni intensive');
            }

            // Analizza distribuzione settimanale
            const slotTotali = materie.reduce((total, materia) => {
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        total += slots.length;
                    });
                }
                return total;
            }, 0);

            if (slotTotali > 20) {
                suggestions.push('‚ö†Ô∏è Troppi slot! Considera di consolidare per evitare frammentazione');
            } else if (slotTotali < 10) {
                suggestions.push('üí° Aggiungi pi√π slot per distribuire meglio il carico di studio');
            }

            // Analizza urgenze
            const materieUrgenti = materie.filter(m => {
                const piano = calcolaPianoMateria(m);
                return piano.urgenza === 'critica' || piano.urgenza === 'alta';
            });

            if (materieUrgenti.length > 0) {
                suggestions.push(`üö® ${materieUrgenti.length} materie richiedono attenzione immediata`);
            }

            return { insights, suggestions };
        }

        function generatePianoStudio() {
            const container = document.getElementById('pianoStudio');
            const insightsContainer = document.getElementById('aiInsights');
            
            if (materie.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                    </div>
                `;
                insightsContainer.innerHTML = '';
                return;
            }

            // Genera AI Insights
            const aiData = generateAIInsights();
            if (aiData.insights.length > 0 || aiData.suggestions.length > 0) {
                insightsContainer.innerHTML = `
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 12px; padding: 1.5rem; border-left: 4px solid var(--primary-color);">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">ü§ñ AI Insights</h4>
                        ${aiData.insights.map(insight => `<p style="margin-bottom: 0.5rem; color: var(--text-primary);">‚Ä¢ ${insight}</p>`).join('')}
                        ${aiData.suggestions.map(suggestion => `<p style="margin-bottom: 0.5rem; color: var(--warning-color);">‚Ä¢ ${suggestion}</p>`).join('')}
                    </div>
                `;
            } else {
                insightsContainer.innerHTML = '';
            }

            let pianoHTML = '';

            materie.forEach(materia => {
                const piano = calcolaPianoMateria(materia);
                
                let urgenzaColor = 'var(--secondary-color)';
                let urgenzaIcon = '‚úÖ';
                if (piano.urgenza === 'critica') {
                    urgenzaColor = 'var(--danger-color)';
                    urgenzaIcon = 'üö®';
                } else if (piano.urgenza === 'alta') {
                    urgenzaColor = 'var(--warning-color)';
                    urgenzaIcon = '‚ö†Ô∏è';
                } else if (piano.urgenza === 'moderata') {
                    urgenzaColor = 'var(--accent-color)';
                    urgenzaIcon = '‚è∞';
                }

                pianoHTML += `
                    <div class="card" style="margin-bottom: 2rem; border-left: 4px solid ${urgenzaColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h4 style="color: var(--primary-light); font-size: 1.4rem; margin: 0;">üìñ ${materia.nome}</h4>
                            <div style="text-align: right;">
                                <div style="color: ${urgenzaColor}; font-weight: 600; font-size: 0.9rem;">${urgenzaIcon} ${piano.urgenza.toUpperCase()}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">${piano.percentualeCompletamento}% completato</div>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--primary-light); margin-bottom: 1rem;">üìä Analisi CFU & Slot</h5>
                            <div class="form-row">
                                <div><strong>CFU:</strong> <span style="color: var(--secondary-color);">${materia.cfu} (${materia.cfu * 25}h standard)</span></div>
                                <div><strong>Ore necessarie (CFU):</strong> <span style="color: var(--primary-light);">${piano.oreNecessarieCFU}h</span></div>
                                <div><strong>Ore necessarie (pagine):</strong> <span style="color: var(--accent-color);">${piano.oreNecessariePagine}h</span></div>
                                <div><strong>Ore settimanali (slot):</strong> <span style="color: var(--secondary-color);">${Math.round(piano.oreSettimanali * 10) / 10}h</span></div>
                                <div><strong>Totale ore necessarie:</strong> <span style="color: var(--danger-color); font-weight: 600;">${piano.oreNecessarie}h</span></div>
                                <div><strong>Ore disponibili:</strong> <span style="color: ${piano.oreTotaliDisponibili >= piano.oreNecessarie ? 'var(--secondary-color)' : 'var(--danger-color)'};">${piano.oreTotaliDisponibili}h</span></div>
                            </div>
                        </div>

                        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--primary-light); margin-bottom: 1rem;">üìÖ Piano Giornaliero Smart</h5>
                            <div class="form-row">
                                <div><strong>Pagine rimanenti:</strong> <span style="color: var(--warning-color);">${piano.pagineRimanenti}</span></div>
                                <div><strong>Pagine/giorno:</strong> <span style="color: var(--accent-color);">${piano.pagineAlGiorno}</span></div>
                                <div><strong>Ore/giorno:</strong> <span style="color: var(--primary-light);">${piano.oreAlGiorno}h</span></div>
                                <div><strong>Giorni rimanenti:</strong> <span style="color: var(--primary-light);">${piano.giorniRimanenti} giorni</span></div>
                            </div>
                        </div>

                        ${piano.raccomandazioni.length > 0 ? `
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                            <h5 style="color: var(--primary-light); margin-bottom: 1rem;">üéØ Raccomandazioni AI</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                ${piano.raccomandazioni.map(rec => `<li style="color: var(--text-primary); margin-bottom: 0.5rem;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${piano.warning ? `
                        <div style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--warning-color);">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> ${piano.warning}
                        </div>
                        ` : `
                        <div style="background: rgba(16, 185, 129, 0.1); color: var(--secondary-color); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--secondary-color);">
                            ‚úÖ <strong>Piano Fattibile:</strong> Hai tempo sufficiente per completare lo studio con gli slot attuali.
                        </div>
                        `}
                    </div>
                `;
            });

            container.innerHTML = pianoHTML;
        }

        // === TIMER POMODORO MIGLIORATO ===
        function setPreset(work, breakTime, targetElement) {
            try {
                if (timerState.isRunning) return;
                
                timerState.workTime = work;
                timerState.breakTime = breakTime;
                timerState.minutes = work;
                timerState.seconds = 0;
                timerState.isBreak = false;
                
                updateTimerDisplay();
                
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                if (targetElement) {
                    targetElement.classList.add('active');
                }
            } catch (error) {
                console.error('Errore nel preset timer:', error);
            }
        }

        function showCustomTimerDialog() {
            if (timerState.isRunning) {
                showSuccessMessage('‚ùå Ferma il timer prima di personalizzare!');
                return;
            }
            
            const modal = document.getElementById('customTimerModal');
            modal.style.display = 'flex';
            
            document.getElementById('customWorkTime').value = timerState.workTime;
            document.getElementById('customBreakTime').value = timerState.breakTime;
        }

        function closeCustomTimerModal() {
            const modal = document.getElementById('customTimerModal');
            modal.style.display = 'none';
        }

        function applyCustomTimer() {
            const workMinutes = parseInt(document.getElementById('customWorkTime').value);
            const breakMinutes = parseInt(document.getElementById('customBreakTime').value);
            
            if (isNaN(workMinutes) || workMinutes < 1 || workMinutes > 180) {
                showSuccessMessage('‚ùå Inserisci minuti di lavoro validi (1-180)');
                return;
            }
            
            if (isNaN(breakMinutes) || breakMinutes < 1 || breakMinutes > 60) {
                showSuccessMessage('‚ùå Inserisci minuti di pausa validi (1-60)');
                return;
            }
            
            timerState.workTime = workMinutes;
            timerState.breakTime = breakMinutes;
            timerState.minutes = workMinutes;
            timerState.seconds = 0;
            timerState.isBreak = false;
            
            updateTimerDisplay();
            
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            const customBtn = document.querySelector('.preset-btn:last-child');
            customBtn.classList.add('active');
            customBtn.textContent = `${workMinutes}/${breakMinutes} min`;
            
            closeCustomTimerModal();
            showSuccessMessage(`‚úÖ Timer personalizzato: ${workMinutes} min lavoro, ${breakMinutes} min pausa`);
        }

        function startTimer() {
            if (timerState.isRunning) return;
            
            // Salva orario inizio sessione per il rating
            currentSessionStartTime = new Date();
            
            timerState.isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-flex';
            
            timerInterval = setInterval(() => {
                if (timerState.seconds === 0) {
                    if (timerState.minutes === 0) {
                        completeSession();
                        return;
                    }
                    timerState.minutes--;
                    timerState.seconds = 59;
                } else {
                    timerState.seconds--;
                }
                
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            timerState.isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('pauseBtn').style.display = 'none';
        }

        function resetTimer() {
            pauseTimer();
            timerState.minutes = timerState.isBreak ? timerState.breakTime : timerState.workTime;
            timerState.seconds = 0;
            currentSessionStartTime = null;
            updateTimerDisplay();
        }

        function completeSession() {
            pauseTimer();
            
            if (!timerState.isBreak) {
                timerState.sessionsToday++;
                studyData.totalSessions++;
                localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                updateSessionDisplay();
                updateStudyStreak();
                recordCompletedSession();
                
                // Mostra modal rating solo per sessioni di lavoro
                setTimeout(() => {
                    showRatingModal();
                }, 500);
                
                timerState.isBreak = true;
                timerState.minutes = timerState.breakTime;
                timerState.seconds = 0;
            } else {
                timerState.isBreak = false;
                timerState.minutes = timerState.workTime;
                timerState.seconds = 0;
                
                showNotification('‚è∞ Pausa finita!', 'Torna al lavoro!');
            }
            
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const display = `${timerState.minutes.toString().padStart(2, '0')}:${timerState.seconds.toString().padStart(2, '0')}`;
            const timerDisplayEl = document.getElementById('timerDisplay');
            const focusTimerEl = document.getElementById('focusTimer');
            
            if (timerDisplayEl) timerDisplayEl.textContent = display;
            if (focusTimerEl) focusTimerEl.textContent = display;
            
            if (timerDisplayEl) {
                if (timerState.isBreak) {
                    timerDisplayEl.classList.add('break-mode');
                } else {
                    timerDisplayEl.classList.remove('break-mode');
                }
            }
        }

        function updateSessionDisplay() {
            const sessionCountEl = document.getElementById('sessionCount');
            const sessionGoalEl = document.getElementById('sessionGoal');
            const sessionProgressEl = document.getElementById('sessionProgress');
            const progressTextEl = document.getElementById('progressText');
            
            updateDailyGoalDisplay();
            
            if (sessionCountEl) sessionCountEl.textContent = timerState.sessionsToday;
            if (sessionGoalEl) sessionGoalEl.textContent = timerState.dailyGoal;
            
            if (sessionProgressEl) {
                const progress = Math.min(100, (timerState.sessionsToday / timerState.dailyGoal) * 100);
                sessionProgressEl.style.width = progress + '%';
            }
            
            if (progressTextEl) {
                if (timerState.sessionsToday === 0) {
                    progressTextEl.textContent = 'Inizia la tua prima sessione!';
                } else if (timerState.sessionsToday >= timerState.dailyGoal) {
                    progressTextEl.textContent = 'üéâ Obiettivo raggiunto! Ottimo lavoro!';
                } else {
                    const remaining = timerState.dailyGoal - timerState.sessionsToday;
                    progressTextEl.textContent = `Ancora ${remaining} sessioni per raggiungere l'obiettivo`;
                }
            }
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        function showNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            }
            showSuccessMessage(`${title} ${message}`);
        }

        function toggleFocusMode() {
            const focusMode = document.getElementById('focusMode');
            const isVisible = focusMode.style.display === 'flex';
            
            if (isVisible) {
                focusMode.style.display = 'none';
            } else {
                focusMode.style.display = 'flex';
                updateTimerDisplay();
                if (!timerState.isRunning && timerState.minutes > 0) {
                    startTimer();
                }
            }
        }

        // === STUDIO STREAK ===
        function updateStudyStreak() {
            const today = new Date().toDateString();
            const lastStudy = studyData.lastStudyDate;
            
            if (lastStudy === today) {
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastStudy === yesterday.toDateString()) {
                studyData.streak++;
            } else if (lastStudy !== today) {
                studyData.streak = timerState.sessionsToday > 0 ? 1 : 0;
            }
            
            if (timerState.sessionsToday > 0) {
                studyData.lastStudyDate = today;
            }
            
            saveStudyData();
            updateStreakDisplay();
        }

        function updateStreakDisplay() {
            const streakNumber = document.getElementById('streakNumber');
            if (streakNumber) {
                streakNumber.textContent = studyData.streak;
            }
        }

        function saveStudyData() {
            localStorage.setItem('studyStreak', studyData.streak.toString());
            localStorage.setItem('lastStudyDate', studyData.lastStudyDate);
            localStorage.setItem('totalSessions', studyData.totalSessions.toString());
            localStorage.setItem('missedTime', studyData.missedTime.toString());
            localStorage.setItem('dailyGoal', timerState.dailyGoal.toString());
        }

        // === STATISTICHE AVANZATE ===
        function updateStatistiche() {
            const container = document.getElementById('statisticheContent');
            
            if (materie.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Nessuna statistica disponibile.</p>
                        <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                    </div>
                `;
                return;
            }
            
            const totaleCFU = materie.reduce((sum, m) => sum + m.cfu, 0);
            const totalePagine = materie.reduce((sum, m) => sum + m.pagine, 0);
            const pagineStudiate = materie.reduce((sum, m) => sum + (m.pagineStudiate || 0), 0);
            const progressoGenerale = Math.round((pagineStudiate / totalePagine) * 100);
            
            // Calcola ore totali settimanali
            let oreTotaliSettimanali = 0;
            materie.forEach(materia => {
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slots.forEach(slot => {
                            oreTotaliSettimanali += calculateTaskDuration(slot.inizio, slot.fine) / 60;
                        });
                    });
                }
            });

            let statisticheHTML = `
                <div class="form-row">
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">üìö Materie Totali</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${totaleCFU}</div>
                    </div>
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--warning-color), #d97706); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">üìñ Progresso</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${progressoGenerale}%</div>
                    </div>
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--accent-color), #d97706); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">‚è∞ Ore/Settimana</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${Math.round(oreTotaliSettimanali)}</div>
                    </div>
                </div>

                <div class="card">
                    <h4 style="color: var(--primary-light);">üèÜ Obiettivi Giornalieri</h4>
                    <div class="form-group">
                        <strong>Sessioni Pomodoro (Target: ${timerState.dailyGoal}/giorno):</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(100, (timerState.sessionsToday / timerState.dailyGoal) * 100)}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                            <span>${timerState.sessionsToday}/${timerState.dailyGoal} sessioni completate</span>
                            <span>${Math.round((timerState.sessionsToday / timerState.dailyGoal) * 100)}%</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4 style="color: var(--primary-light);">üìä Analisi Dettagliata</h4>
                    <div class="form-row">
                        <div><strong>Pagine totali:</strong> ${totalePagine}</div>
                        <div><strong>Pagine studiate:</strong> ${pagineStudiate}</div>
                        <div><strong>Pagine rimanenti:</strong> ${totalePagine - pagineStudiate}</div>
                        <div><strong>Streak attuale:</strong> ${studyData.streak} giorni</div>
                        <div><strong>Sessioni totali:</strong> ${studyData.totalSessions}</div>
                        <div><strong>Tempo recovery:</strong> ${Math.floor(studyData.missedTime/60)}h ${studyData.missedTime%60}min</div>
                    </div>
                </div>
            `;

            container.innerHTML = statisticheHTML;
        }

        // === CALENDARIO FUNZIONALIT√Ä ===
        function renderCalendar() {
            try {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                // Aggiorna header
                const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                                  'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                const monthYearElement = document.getElementById('currentMonthYear');
                if (monthYearElement) {
                    monthYearElement.textContent = `${monthNames[month]} ${year}`;
                }
                
                // Genera calendario
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const today = new Date();
                
                // Calcola il primo luned√¨ da mostrare
                const startDate = new Date(firstDay);
                const dayOfWeek = (firstDay.getDay() + 6) % 7; // Converti da domenica=0 a luned√¨=0
                startDate.setDate(firstDay.getDate() - dayOfWeek);
                
                const calendarGrid = document.getElementById('calendarGrid');
                if (!calendarGrid) {
                    console.error('Calendar grid element not found');
                    return;
                }
                
                calendarGrid.innerHTML = '';
                
                // Genera 42 giorni (6 settimane)
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    const dayElement = createCalendarDay(currentDate, month, today);
                    calendarGrid.appendChild(dayElement);
                }
                
                updateMonthStats();
                
            } catch (error) {
                console.error('Errore nel rendering calendario:', error);
                const calendarGrid = document.getElementById('calendarGrid');
                if (calendarGrid) {
                    calendarGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--danger-color); padding: 2rem;">Errore nel caricamento calendario</div>';
                }
            }
        }

        function createCalendarDay(date, currentMonth, today) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.toDateString() === today.toDateString();
            const dateKey = date.toISOString().split('T')[0];
            
            if (!isCurrentMonth) {
                dayDiv.classList.add('other-month');
            }
            
            if (isToday) {
                dayDiv.classList.add('today');
            }
            
            // Numero del giorno
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);
            
            // Container sessioni
            const sessionsContainer = document.createElement('div');
            sessionsContainer.className = 'calendar-sessions';
            
            // Controlla sessioni esistenti
            const dayData = calendarSessions[dateKey] || { completed: 0, scheduled: 0, manual: 0 };
            
            // Controlla slot programmati per oggi
            if (isCurrentMonth) {
                const dayName = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][date.getDay()];
                const scheduledSlots = materie.reduce((total, materia) => {
                    if (materia.slotSettimanali && materia.slotSettimanali[dayName]) {
                        return total + materia.slotSettimanali[dayName].length;
                    }
                    return total;
                }, 0);
                
                if (scheduledSlots > 0) {
                    dayDiv.classList.add('has-scheduled');
                    dayData.scheduled = scheduledSlots;
                }
            }
            
            // Aggiungi indicatori sessioni
            const totalSessions = (dayData.completed || 0) + (dayData.manual || 0);
            if (totalSessions > 0) {
                dayDiv.classList.add('has-sessions');
                
                // Mostra fino a 5 pallini
                const maxDots = Math.min(5, totalSessions);
                for (let i = 0; i < maxDots; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'calendar-session-dot';
                    
                    if (i < (dayData.completed || 0)) {
                        dot.classList.add('session-completed');
                    } else {
                        dot.classList.add('session-manual');
                    }
                    
                    sessionsContainer.appendChild(dot);
                }
                
                // Se ci sono pi√π di 5 sessioni, mostra il numero
                if (totalSessions > 5) {
                    const count = document.createElement('div');
                    count.className = 'calendar-session-count';
                    count.textContent = `+${totalSessions - 5}`;
                    sessionsContainer.appendChild(count);
                }
            }
            
            dayDiv.appendChild(sessionsContainer);
            
            // Event listener per click - ZOOM IN GIORNO
            dayDiv.addEventListener('click', () => {
                showDayDetailModal(date, dayData, dateKey);
            });
            
            return dayDiv;
        }

        // === MODAL DETTAGLI GIORNO (ZOOM IN) ===
        function showDayDetailModal(date, dayData, dateKey) {
            const modal = document.getElementById('dayDetailModal');
            if (!modal) {
                console.error('Day detail modal not found');
                return;
            }
            
            const titleEl = document.getElementById('dayDetailTitle');
            const contentEl = document.getElementById('dayDetailContent');
            
            const dateStr = date.toLocaleDateString('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            titleEl.textContent = `üìÖ ${dateStr}`;
            
            // Raccogli tutte le sessioni del giorno
            const daySessions = [];
            
            // Sessioni completate dal timer
            if (sessionRatings[dateKey]) {
                Object.keys(sessionRatings[dateKey]).forEach(hour => {
                    sessionRatings[dateKey][hour].forEach(session => {
                        const startTime = new Date(session.timestamp);
                        daySessions.push({
                            type: 'completed',
                            startTime: startTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                            duration: session.duration,
                            rating: session.rating,
                            note: session.note || '',
                            id: session.timestamp,
                            materia: 'Sessione Pomodoro'
                        });
                    });
                });
            }
            
            // Sessioni manuali dalle detailed sessions
            const dayDetailedSessions = JSON.parse(localStorage.getItem('todayDetailedSessions')) || [];
            if (dateKey === new Date().toISOString().split('T')[0]) {
                // Se √® oggi, usa le sessioni dettagliate
                dayDetailedSessions.forEach(session => {
                    daySessions.push({
                        type: 'detailed',
                        startTime: session.startTime,
                        endTime: session.endTime,
                        duration: session.duration,
                        rating: session.rating,
                        note: session.note || '',
                        id: session.id,
                        materia: session.materia
                    });
                });
            }
            
            // Slot programmati per questo giorno
            const dayName = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][date.getDay()];
            const scheduledSlots = [];
            materie.forEach(materia => {
                if (materia.slotSettimanali && materia.slotSettimanali[dayName]) {
                    materia.slotSettimanali[dayName].forEach(slot => {
                        scheduledSlots.push({
                            type: 'scheduled',
                            startTime: slot.inizio,
                            endTime: slot.fine,
                            duration: calculateTaskDuration(slot.inizio, slot.fine),
                            materia: materia.nome
                        });
                    });
                }
            });
            
            // Ordina per orario
            daySessions.sort((a, b) => a.startTime.localeCompare(b.startTime));
            
            let contentHTML = '';
            
            // Statistiche del giorno
            const totalSessions = daySessions.length;
            const totalMinutes = daySessions.reduce((sum, s) => sum + s.duration, 0);
            const avgRating = totalSessions > 0 ? 
                daySessions.filter(s => s.rating).reduce((sum, s) => sum + s.rating, 0) / daySessions.filter(s => s.rating).length : 0;
            
            contentHTML += `
                <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                    <h4 style="color: var(--primary-light); margin-bottom: 1rem;">üìä Riepilogo Giorno</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-color);">${totalSessions}</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">Sessioni</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);">${Math.round(totalMinutes / 60 * 10) / 10}h</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">Tempo Totale</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-color);">${scheduledSlots.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">Slot Programmati</div>
                        </div>
                        ${avgRating > 0 ? `
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${avgRating.toFixed(1)}/4</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">Rating Medio</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Sessioni completate
            if (daySessions.length > 0) {
                contentHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">‚úÖ Sessioni Completate</h4>
                        <div class="day-sessions-grid">
                `;
                
                daySessions.forEach(session => {
                    const ratingStars = session.rating ? '‚òÖ'.repeat(session.rating) + '‚òÜ'.repeat(4 - session.rating) : '';
                    
                    contentHTML += `
                        <div class="day-session-item">
                            <div class="session-details">
                                <div class="session-title">${session.materia}</div>
                                <div class="session-meta">
                                    ${session.endTime ? `${session.startTime} - ${session.endTime}` : session.startTime} ‚Ä¢ 
                                    ${session.duration} min
                                    ${session.rating ? ` ‚Ä¢ ${ratingStars}` : ''}
                                </div>
                                ${session.note ? `<div style="font-style: italic; color: var(--text-secondary); margin-top: 0.5rem;">"${session.note}"</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-danger btn-small" onclick="deleteSessionFromCalendar('${dateKey}', ${session.id})" title="Elimina sessione">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div></div>`;
            }
            
            // Slot programmati
            if (scheduledSlots.length > 0) {
                contentHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">üìã Slot Programmati</h4>
                        <div class="day-sessions-grid">
                `;
                
                scheduledSlots.forEach(slot => {
                    contentHTML += `
                        <div class="day-session-item">
                            <div class="session-details">
                                <div class="session-title">${slot.materia}</div>
                                <div class="session-meta">
                                    ${slot.startTime} - ${slot.endTime} ‚Ä¢ ${slot.duration} min
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                contentHTML += `</div></div>`;
            }
            
            // Se non ci sono sessioni o slot
            if (daySessions.length === 0 && scheduledSlots.length === 0) {
                contentHTML += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Nessuna attivit√† registrata per questo giorno.</p>
                    </div>
                `;
            }
            
            // Pulsante aggiungi sessione manuale
            contentHTML += `
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="addSessionForSpecificDay('${dateKey}')">
                        ‚ûï Aggiungi Sessione a questo Giorno
                    </button>
                </div>
            `;
            
            contentEl.innerHTML = contentHTML;
            modal.style.display = 'flex';
        }

        function deleteSessionFromCalendar(dateKey, sessionId) {
            try {
                // Se √® oggi, elimina dalle sessioni dettagliate
                const today = new Date().toISOString().split('T')[0];
                if (dateKey === today) {
                    const sessionIndex = todayDetailedSessions.findIndex(s => s.id === sessionId);
                    if (sessionIndex !== -1) {
                        deleteSpecificSession(sessionId);
                        // Ricarica il modal
                        const date = new Date(dateKey);
                        const dayData = calendarSessions[dateKey] || { completed: 0, scheduled: 0, manual: 0 };
                        showDayDetailModal(date, dayData, dateKey);
                        return;
                    }
                }
                
                // Elimina dai rating
                if (sessionRatings[dateKey]) {
                    let found = false;
                    Object.keys(sessionRatings[dateKey]).forEach(hour => {
                        const ratingIndex = sessionRatings[dateKey][hour].findIndex(r => r.timestamp === sessionId);
                        if (ratingIndex !== -1) {
                            sessionRatings[dateKey][hour].splice(ratingIndex, 1);
                            if (sessionRatings[dateKey][hour].length === 0) {
                                delete sessionRatings[dateKey][hour];
                            }
                            found = true;
                        }
                    });
                    
                    if (found) {
                        localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                        
                        // Aggiorna calendario sessioni
                        if (calendarSessions[dateKey] && calendarSessions[dateKey].completed > 0) {
                            calendarSessions[dateKey].completed--;
                            localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                        }
                        
                        // Aggiorna UI
                        renderCalendar();
                        updateHeatmap();
                        updateProductivitySection();
                        
                        showSuccessMessage('‚úÖ Sessione eliminata dal calendario');
                        
                        // Ricarica il modal
                        const date = new Date(dateKey);
                        const dayData = calendarSessions[dateKey] || { completed: 0, scheduled: 0, manual: 0 };
                        showDayDetailModal(date, dayData, dateKey);
                    } else {
                        showSuccessMessage('‚ùå Sessione non trovata');
                    }
                }
                
            } catch (error) {
                console.error('Errore nell\'eliminazione sessione dal calendario:', error);
                showSuccessMessage('‚ùå Errore nell\'eliminazione della sessione');
            }
        }

        function addSessionForSpecificDay(dateKey) {
            closeDayDetailModal();
            
            // Pre-imposta la data nel modal di aggiunta sessione
            const modal = document.getElementById('addSessionModal');
            if (modal) {
                const dateInput = document.getElementById('sessionDate');
                if (dateInput) {
                    dateInput.value = dateKey;
                }
                
                // Popola select materie
                const materieSelect = document.getElementById('sessionMateria');
                if (materieSelect) {
                    materieSelect.innerHTML = '<option value="">Sessione generica</option>';
                    materie.forEach(materia => {
                        const option = document.createElement('option');
                        option.value = materia.nome;
                        option.textContent = materia.nome;
                        materieSelect.appendChild(option);
                    });
                }
                
                modal.style.display = 'flex';
            }
        }

        function closeDayDetailModal() {
            const modal = document.getElementById('dayDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function addManualSession() {
            const modal = document.getElementById('addSessionModal');
            if (!modal) {
                console.error('Add session modal not found');
                return;
            }
            
            // Pre-compila con oggi - FIXED per timezone Italia/Napoli
            const today = new Date();
            // Forza il timezone locale italiano per evitare problemi UTC
            const italianDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
            const dateString = italianDate.toISOString().split('T')[0];
            
            const dateInput = document.getElementById('sessionDate');
            if (dateInput) {
                dateInput.value = dateString;
            }
            
            // Popola select materie
            const materieSelect = document.getElementById('sessionMateria');
            if (materieSelect) {
                materieSelect.innerHTML = '<option value="">Sessione generica</option>';
                materie.forEach(materia => {
                    const option = document.createElement('option');
                    option.value = materia.nome;
                    option.textContent = materia.nome;
                    materieSelect.appendChild(option);
                });
            }
            
            modal.style.display = 'flex';
        }

        function closeAddSessionModal() {
            const modal = document.getElementById('addSessionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function saveManualSession() {
            try {
                const dateInput = document.getElementById('sessionDate');
                const materiaInput = document.getElementById('sessionMateria');
                const durationInput = document.getElementById('sessionDuration');
                const noteInput = document.getElementById('manualSessionNote');
                
                if (!dateInput || !durationInput) {
                    showSuccessMessage('‚ùå Errore nel form. Ricarica la pagina e riprova.');
                    return;
                }
                
                const date = dateInput.value;
                const materia = materiaInput ? materiaInput.value : '';
                const duration = parseInt(durationInput.value);
                const note = noteInput ? noteInput.value : '';
                
                if (!date || !duration || duration < 1) {
                    showSuccessMessage('‚ùå Data e durata (minimo 1 minuto) sono obbligatorie');
                    return;
                }
                
                // FIXED per timezone Italia: Crea data locale esplicita
                const dateParts = date.split('-');
                const sessionDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]), 12, 0, 0);
                const timestamp = sessionDate.getTime() + Math.random() * 1000;
                
                // Inizializza calendarSessions se non esiste
                if (!calendarSessions) {
                    calendarSessions = {};
                }
                
                // Salva sessione nel calendario
                if (!calendarSessions[date]) {
                    calendarSessions[date] = { completed: 0, manual: 0 };
                }
                
                calendarSessions[date].manual = (calendarSessions[date].manual || 0) + 1;
                
                // Salva anche nei rating per la heatmap
                const hour = 12; // Usa ora fissa per sessioni manuali
                if (!sessionRatings[date]) {
                    sessionRatings[date] = {};
                }
                if (!sessionRatings[date][hour]) {
                    sessionRatings[date][hour] = [];
                }
                
                sessionRatings[date][hour].push({
                    rating: 3, // Rating default per sessioni manuali
                    timestamp: timestamp,
                    duration: duration,
                    note: note,
                    type: 'manual'
                });
                
                // Salva nei dati di studio se √® oggi
                const now = new Date();
                const todayKey = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
                if (date === todayKey) {
                    timerState.sessionsToday += 1;
                    studyData.totalSessions += 1;
                    localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                    localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                    
                    // Aggiungi anche alle sessioni dettagliate di oggi
                    const sessionDetails = {
                        id: timestamp,
                        startTime: '12:00', // Ora fissa per sessioni manuali
                        endTime: `${12 + Math.floor(duration / 60)}:${(60 + duration % 60).toString().padStart(2, '0')}`.replace('60:', '00:'),
                        duration: duration,
                        rating: 3,
                        note: note,
                        materia: materia || 'Sessione manuale',
                        date: date,
                        type: 'manual'
                    };
                    
                    todayDetailedSessions.push(sessionDetails);
                    localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                    updateTodaySessionsList();
                    updateSessionDisplay();
                    updateStudyStreak();
                }
                
                // Salva nel localStorage
                localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                
                // Aggiorna UI
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                closeAddSessionModal();
                
                const materiaText = materia ? ` per ${materia}` : '';
                showSuccessMessage(`‚úÖ Sessione di ${duration} min${materiaText} aggiunta per ${new Date(date).toLocaleDateString('it-IT')}`);
                
                // Reset form
                if (noteInput) noteInput.value = '';
                if (durationInput) durationInput.value = '25';
                
            } catch (error) {
                console.error('Errore nel salvataggio sessione manuale:', error);
                showSuccessMessage('‚ùå Errore nel salvataggio della sessione. Verifica i dati e riprova.');
            }
        }

        function updateMonthStats() {
            try {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                let totalSessions = 0;
                let totalMinutes = 0;
                let activeDays = 0;
                
                // Conta sessioni del mese corrente
                Object.keys(calendarSessions).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const dayData = calendarSessions[dateKey];
                        const daySessions = (dayData.completed || 0) + (dayData.manual || 0);
                        
                        if (daySessions > 0) {
                            totalSessions += daySessions;
                            totalMinutes += daySessions * 25; // Stima 25 min per sessione
                            activeDays++;
                        }
                    }
                });
                
                // Aggiorna UI
                const monthSessionsEl = document.getElementById('monthSessions');
                const monthHoursEl = document.getElementById('monthHours');
                const monthDaysEl = document.getElementById('monthDays');
                const monthAverageEl = document.getElementById('monthAverage');
                
                if (monthSessionsEl) monthSessionsEl.textContent = totalSessions;
                if (monthHoursEl) monthHoursEl.textContent = Math.round(totalMinutes / 60) + 'h';
                if (monthDaysEl) monthDaysEl.textContent = activeDays;
                if (monthAverageEl) monthAverageEl.textContent = activeDays > 0 ? Math.round(totalSessions / activeDays * 10) / 10 : 0;
                
            } catch (error) {
                console.error('Errore nell\'aggiornamento statistiche mensili:', error);
            }
        }

        // Registra sessioni completate dal timer
        function recordCompletedSession() {
            try {
                // FIXED per timezone Italia/Napoli
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
                
                if (!calendarSessions[today]) {
                    calendarSessions[today] = { completed: 0, manual: 0 };
                }
                
                calendarSessions[today].completed = (calendarSessions[today].completed || 0) + 1;
                localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
            } catch (error) {
                console.error('Errore nel recording sessione:', error);
            }
        }

        // === UTILIT√Ä ===
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                backdrop-filter: blur(10px);
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%) scale(0.8); opacity: 0; }
                    to { transform: translateX(0) scale(1); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0) scale(1); opacity: 1; }
                    to { transform: translateX(100%) scale(0.8); opacity: 0; }
                }
            `;
            
            document.head.appendChild(style);
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                    if (document.head.contains(style)) {
                        document.head.removeChild(style);
                    }
                }, 400);
            }, 4000);
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') {
                return;
            }

            if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                e.preventDefault();
                if (timerState.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                resetTimer();
            }
            
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                toggleFocusMode();
            }
            
            if (e.key === 'Escape') {
                const focusMode = document.getElementById('focusMode');
                const customModal = document.getElementById('customTimerModal');
                const recoveryModal = document.getElementById('recoveryModal');
                const ratingModal = document.getElementById('ratingModal');
                const addSessionModal = document.getElementById('addSessionModal');
                const dayDetailModal = document.getElementById('dayDetailModal');
                
                if (focusMode && focusMode.style.display === 'flex') {
                    toggleFocusMode();
                } else if (customModal && customModal.style.display === 'flex') {
                    closeCustomTimerModal();
                } else if (recoveryModal && recoveryModal.style.display === 'flex') {
                    closeRecoveryModal();
                } else if (ratingModal && ratingModal.style.display === 'flex') {
                    // Non chiudere il rating modal con ESC - vogliamo che l'utente valuti
                } else if (addSessionModal && addSessionModal.style.display === 'flex') {
                    closeAddSessionModal();
                } else if (dayDetailModal && dayDetailModal.style.display === 'flex') {
                    closeDayDetailModal();
                }
            }

            // Shortcuts per rating rapido (1-4)
            if (document.getElementById('ratingModal').style.display === 'flex') {
                if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    submitRating(parseInt(e.key));
                }
            }

            if (e.key >= '1' && e.key <= '6' && document.getElementById('ratingModal').style.display !== 'flex') {
                e.preventDefault();
                const sections = ['oggi', 'materie', 'piano', 'pomodoro', 'calendario', 'statistiche'];
                const sectionIndex = parseInt(e.key) - 1;
                if (sections[sectionIndex]) {
                    const tabs = document.querySelectorAll('.nav-tab');
                    if (tabs[sectionIndex]) {
                        showSection(sections[sectionIndex], tabs[sectionIndex]);
                    }
                }
            }
        });

        // Event listeners per modal
        document.addEventListener('click', (e) => {
            const customModal = document.getElementById('customTimerModal');
            const recoveryModal = document.getElementById('recoveryModal');
            const addSessionModal = document.getElementById('addSessionModal');
            const dayDetailModal = document.getElementById('dayDetailModal');
            
            if (e.target === customModal) {
                closeCustomTimerModal();
            }
            if (e.target === recoveryModal) {
                closeRecoveryModal();
            }
            if (e.target === addSessionModal) {
                closeAddSessionModal();
            }
            if (e.target === dayDetailModal) {
                closeDayDetailModal();
            }
            // Non chiudere il rating modal cliccando fuori - vogliamo che l'utente valuti
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Controllo se le date delle sessioni sono di oggi, altrimenti reset
                const today = new Date().toDateString();
                const lastSessionDate = localStorage.getItem('lastSessionDate');
                
                if (lastSessionDate !== today) {
                    timerState.sessionsToday = 0;
                    localStorage.setItem('sessionsToday', '0');
                    localStorage.setItem('lastSessionDate', today);
                }
                
                // Inizializza displays
                updateSessionDisplay();
                updateStreakDisplay();
                setupStarRating();
                loadMaterie();
                generateTodaySchedule();
                generatePianoStudio();
                updateStatistiche();
                renderCalendar();
                initializeHeatmap();
                updateProductivitySection();
                initializeWeeklySlots();
                updateTodaySessionsList();
                
                console.log('üöÄ Piano Studio Smart AI Pro - App completamente inizializzata!');
                console.log('‚å®Ô∏è Shortcuts: 1-6 (sezioni), Ctrl+Space (timer), F (focus), Esc (chiudi), 1-4 (rating veloce)');
                console.log('üéØ Funzionalit√† implementate e FIXED:');
                console.log('  ‚Ä¢ ‚úÖ FIXED: Bug calendario - le sessioni vengono salvate nel giorno corretto');
                console.log('  ‚Ä¢ ‚úÖ FIXED: Sistema eliminazione sessioni specifiche con dettagli completi');
                console.log('  ‚Ä¢ ‚úÖ NEW: Lista sessioni dettagliate nella pagina Pomodoro con note e rating');
                console.log('  ‚Ä¢ ‚úÖ NEW: Modal "zoom in" giorno calendario con gestione completa sessioni');
                console.log('  ‚Ä¢ ‚úÖ NEW: Possibilit√† di eliminare sessioni specifiche dal calendario');
                console.log('  ‚Ä¢ ‚úÖ NEW: Possibilit√† di aggiungere note a ogni sessione');
                console.log('  ‚Ä¢ üìä Modal Rating Post-Sessione con note e emoji interattive');
                console.log('  ‚Ä¢ üî• Heatmap 24 ore per visualizzare la produttivit√† oraria');
                console.log('  ‚Ä¢ üèÜ Top 3 ore migliori con suggerimenti AI personalizzati');
                console.log('  ‚Ä¢ ‚è∞ Sistema slot temporali completo per ogni materia');
                console.log('  ‚Ä¢ üéØ Task options personalizzabili e micro-tasks anti-procrastinazione');
                console.log('  ‚Ä¢ üìÖ Calendario interattivo con zoom giorni e statistiche mensili');
                console.log('  ‚Ä¢ ü§ñ AI Insights per piano studio intelligente');
                console.log('  ‚Ä¢ üí° Sistema di tracking intelligente per ottimizzare gli orari di studio');
                console.log('  ‚Ä¢ üîß Sistema recupero graduale tempo perso');
                console.log('  ‚Ä¢ üìù Gestione completa materie con CFU, esercizi, progressi');
                console.log('  ‚Ä¢ ‚å®Ô∏è Shortcuts veloci e focus mode per produttivit√†');
                console.log('  ‚Ä¢ üé® Design moderno con animazioni premium e UX ottimizzata');
                
            } catch (error) {
                console.error('Errore nell\'inizializzazione:', error);
                showSuccessMessage('‚ö†Ô∏è Errore nell\'inizializzazione. Ricarica la pagina.');
            }
        });

    </script>
</body>
</html>; font-weight: 800;">${materie.length}</div>
                    </div>
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark)); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">üéì CFU Totali</h4>
                        <div style="font-size: 3rem
